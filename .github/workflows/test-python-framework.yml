name: Python Framework Tests

on:
  workflow_call:
    inputs:
      postgres-image:
        description: "PostgreSQL with PGMQ image tag"
        required: true
        type: string

jobs:
  python-framework:
    name: Python Framework Tests (with PostgreSQL)
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        env:
          POSTGRES_DB: tasker_rust_test
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U tasker -d tasker_rust_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: workers/python

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Setup Rust (for maturin build)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-python-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-python-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features native-tls,postgres

      - name: Run database migrations
        run: cargo sqlx migrate run
        working-directory: .
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Install Python dependencies
        run: uv sync --dev

      - name: Build Python FFI extension with maturin
        run: uv run maturin develop
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Create test results directory
        run: mkdir -p ../../target

      - name: Run Python framework tests
        run: |
          echo "ðŸ§ª Running Python framework tests (FFI, types, events, worker)..."
          echo "   - tests/test_bootstrap.py - FFI bootstrap integration"
          echo "   - tests/test_handler_registry.py - Handler registry"
          echo "   - tests/test_events.py - Event system"
          echo "   - tests/test_models.py - Type models and conversions"
          echo ""

          uv run pytest tests/ \
            -v \
            --tb=short \
            --junitxml=../../target/python-framework-results.xml
        env:
          TASKER_ENV: test
          PYTHON_HANDLER_PATH: ./tests/handlers
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Upload test results
        uses: actions/upload-artifact@v5
        if: always() && hashFiles('target/python-framework-results.xml') != ''
        with:
          name: python-framework-test-results
          path: target/python-framework-results.xml

      - name: Display test summary
        if: always()
        run: |
          echo "ðŸ“Š Python Framework Test Summary"
          echo "================================="
          if [ -f "../../target/python-framework-results.xml" ]; then
            test_count=$(grep -o '<testcase' ../../target/python-framework-results.xml | wc -l || echo "0")
            echo "Total tests: $test_count"
            echo "âœ… Framework tests completed"
          else
            echo "âš ï¸ No test results file found"
          fi
