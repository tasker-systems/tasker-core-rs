name: TypeScript Framework Tests

on:
  workflow_call:
    inputs:
      postgres-image:
        description: "PostgreSQL with PGMQ image tag"
        required: true
        type: string

jobs:
  typescript-framework:
    name: TypeScript Framework Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    # PostgreSQL service for FFI bootstrap tests
    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        env:
          POSTGRES_DB: tasker_rust_test
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U tasker -d tasker_rust_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: workers/typescript

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space

      # ========================================================================
      # Setup all JavaScript runtimes for multi-runtime FFI testing
      # ========================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: 'latest'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # ========================================================================
      # Download FFI library artifact from build-workers
      # ========================================================================
      - name: Download worker artifacts
        uses: actions/download-artifact@v4
        with:
          name: worker-artifacts
          path: artifacts/

      - name: Setup FFI library path
        run: |
          echo "ðŸ“¦ Setting up FFI library..."
          # Create target/release at repo root (not in workers/typescript)
          mkdir -p ../../target/release

          # Artifacts are downloaded to repo root (download-artifact ignores working-directory)
          echo "ðŸ“‹ Looking for FFI library in artifacts..."
          find ../../artifacts -name "*.so" -o -name "*.dylib" 2>/dev/null || echo "No .so/.dylib files found"

          # Copy FFI library from artifacts (try various paths)
          if [ -f "../../artifacts/target/release/libtasker_worker.so" ]; then
            cp ../../artifacts/target/release/libtasker_worker.so ../../target/release/
            echo "âœ… Copied libtasker_worker.so from artifacts/target/release/"
          elif [ -f "../../artifacts/libtasker_worker.so" ]; then
            cp ../../artifacts/libtasker_worker.so ../../target/release/
            echo "âœ… Copied libtasker_worker.so from artifacts/ (flat)"
          else
            echo "âš ï¸ FFI library not found in artifacts, FFI tests will skip"
          fi

          ls -la ../../target/release/ || true

      # ========================================================================
      # Quality Checks and Unit Tests (no FFI required)
      # ========================================================================
      - name: Run quality checks (lint + typecheck)
        run: |
          echo "ðŸ” Running Biome lint and TypeScript type checks..."
          cargo make lint
          cargo make typecheck

      - name: Run TypeScript unit tests
        run: |
          echo "ðŸ§ª Running TypeScript unit tests (FFI types, events, runtime)..."
          echo "   - tests/unit/ffi/ - FFI types and runtime detection"
          echo "   - tests/unit/events/ - Event emitter and poller"
          echo ""

          cargo make test-ci
        env:
          TASKER_ENV: test

      # ========================================================================
      # FFI Integration Tests (multi-runtime)
      # ========================================================================
      - name: Run FFI integration tests (Bun)
        run: |
          echo "ðŸ§ª Running Bun FFI integration tests..."
          bun test tests/integration/ffi/bun-runtime.test.ts 2>&1 | tee ../../target/typescript-ffi-bun-results.txt

          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ Bun FFI tests failed"
            exit 1
          fi
          echo "âœ… Bun FFI tests passed"
        env:
          TASKER_ENV: test
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test
          FFI_BOOTSTRAP_TESTS: "true"

      - name: Run FFI integration tests (Node.js)
        run: |
          echo "ðŸ§ª Running Node.js FFI integration tests..."
          # Node.js requires tsx for TypeScript support
          npx tsx --test tests/integration/ffi/node-runtime.test.ts 2>&1 | tee ../../target/typescript-ffi-node-results.txt

          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âš ï¸ Node.js FFI tests failed (may be due to ffi-napi not installed)"
          else
            echo "âœ… Node.js FFI tests passed"
          fi
        env:
          TASKER_ENV: test
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test
          FFI_BOOTSTRAP_TESTS: "true"
        continue-on-error: true  # Node.js FFI is optional (requires ffi-napi)

      - name: Run FFI integration tests (Deno)
        run: |
          echo "ðŸ§ª Running Deno FFI integration tests..."
          # Deno requires explicit permissions for FFI, environment, and file access
          deno test --allow-ffi --allow-env --allow-read tests/integration/ffi/deno-runtime.test.ts 2>&1 | tee ../../target/typescript-ffi-deno-results.txt

          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âš ï¸ Deno FFI tests failed"
          else
            echo "âœ… Deno FFI tests passed"
          fi
        env:
          TASKER_ENV: test
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test
          FFI_BOOTSTRAP_TESTS: "true"
        continue-on-error: true  # Deno FFI may have compatibility issues

      # ========================================================================
      # Build and Summary
      # ========================================================================
      - name: Run build
        run: |
          echo "ðŸ“¦ Building TypeScript package..."
          bun run build

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: typescript-framework-test-results
          path: |
            target/typescript-unit-results.txt
            target/typescript-ffi-bun-results.txt
            target/typescript-ffi-node-results.txt
            target/typescript-ffi-deno-results.txt
          if-no-files-found: warn

      - name: Display test summary
        if: always()
        run: |
          echo "ðŸ“Š TypeScript Framework Test Summary"
          echo "====================================="
          echo ""
          echo "Unit Tests:"
          if [ -f "../../target/typescript-unit-results.txt" ]; then
            tail -5 ../../target/typescript-unit-results.txt
          else
            echo "âš ï¸ No unit test results"
          fi
          echo ""
          echo "FFI Integration Tests:"
          echo "  Bun:     $(grep -c 'pass' ../../target/typescript-ffi-bun-results.txt 2>/dev/null || echo '?') tests"
          echo "  Node.js: $(grep -c 'pass' ../../target/typescript-ffi-node-results.txt 2>/dev/null || echo 'skipped/failed')"
          echo "  Deno:    $(grep -c 'pass' ../../target/typescript-ffi-deno-results.txt 2>/dev/null || echo 'skipped/failed')"
          echo ""
          echo "âœ… TypeScript framework tests completed"
