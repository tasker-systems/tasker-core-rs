name: Ruby Framework Tests

on:
  workflow_call:
    inputs:
      postgres-image:
        description: "PostgreSQL with PGMQ image tag"
        required: true
        type: string

jobs:
  ruby-framework:
    name: Ruby Framework Tests (with PostgreSQL)
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        env:
          POSTGRES_DB: tasker_rust_test
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U tasker -d tasker_rust_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # TAS-156: Redis for distributed template cache
      redis:
        image: redis:7-alpine
        ports:
          - "6379:6379"
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: workers/ruby

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true
          working-directory: workers/ruby

      - name: Setup Rust (for sqlx-cli)
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust build cache
        uses: ./.github/actions/setup-rust-cache

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Install protobuf compiler
        uses: ./.github/actions/install-protobuf

      - name: Install tools
        uses: ./.github/actions/install-tools
        with:
          tools: "sqlx-cli make"

      - name: Run database migrations
        run: cargo sqlx migrate run
        working-directory: .
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Install Ruby dependencies
        run: bundle install

      - name: Download pre-built Ruby extension
        uses: actions/download-artifact@v7
        with:
          name: ruby-extension
          path: artifacts
        continue-on-error: true

      - name: Restore or compile Ruby FFI extension
        run: |
          # Try to use pre-built extension from build-ruby job
          if [ -d artifacts ] && (ls artifacts/*.bundle 2>/dev/null || ls artifacts/*.so 2>/dev/null); then
            echo "ðŸ“¦ Restoring pre-built Ruby extension..."
            ARTIFACTS_DIR=artifacts ../../cargo-make/scripts/ci-restore-ruby-extension.sh
          else
            echo "ðŸ”¨ Building Ruby extension from source..."
            bundle exec rake compile
          fi
        env:
          SQLX_OFFLINE: "true"

      - name: Run Ruby framework tests
        run: |
          echo "ðŸ§ª Running Ruby framework tests (FFI, types, events, worker)..."
          echo "   - spec/ffi/ - FFI layer integration"
          echo "   - spec/types/ - Type wrappers and conversions"
          echo "   - spec/worker/ - Worker core functionality"
          echo "   - spec/events/ - Event system"
          echo ""

          cargo make test-ci
        env:
          TASKER_ENV: test
          # Use worker-test.toml with unique port to enable health/observability FFI
          TASKER_CONFIG_PATH: ../../config/tasker/generated/worker-test.toml
          TASKER_WEB_BIND_ADDRESS: "0.0.0.0:8182"
          TASKER_WORKER_GRPC_BIND_ADDRESS: "0.0.0.0:9182"
          TASKER_TEMPLATE_PATH: ./spec/fixtures/templates
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test
          # TAS-156: Redis for distributed template cache
          REDIS_URL: redis://localhost:6379

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always() && hashFiles('target/ruby-framework-results.xml') != ''
        with:
          name: ruby-framework-test-results
          path: target/ruby-framework-results.xml

      - name: Display test summary
        if: always()
        run: |
          echo "ðŸ“Š Ruby Framework Test Summary"
          echo "================================"
          if [ -f "../../target/ruby-framework-results.xml" ]; then
            test_count=$(grep -o '<testcase' ../../target/ruby-framework-results.xml | wc -l || echo "0")
            echo "Total tests: $test_count"
            echo "âœ… Framework tests completed"
          else
            echo "âš ï¸ No test results file found"
          fi
