name: Ruby Unit Tests

on:
  workflow_call:

jobs:
  ruby-unit:
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        ruby-version: ['3.4']

    defaults:
      run:
        working-directory: workers/ruby

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ruby-unit-${{ matrix.ruby-version }}
          workspaces: |
            . -> target
            workers/ruby -> target

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}
          bundler-cache: true
          working-directory: workers/ruby

      - name: Compile Ruby FFI extension
        run: bundle exec rake compile

      - name: Create test results directory
        run: mkdir -p ../../target

      - name: Run Ruby unit tests with performance monitoring
        run: |
          echo "🧪 Starting Ruby unit tests with performance monitoring..."
          START_TIME=$(date +%s)

          # Run tests with timing
          time bundle exec rspec spec/ffi/ spec/types/ spec/worker/ \
            --format documentation \
            --format RspecJunitFormatter \
            --out ../../target/ruby-unit-results.xml \
            2>&1 | tee ../../target/ruby-unit-output.log

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "⏱️ Unit tests completed in ${DURATION} seconds"
          echo "unit_test_duration_seconds=${DURATION}" >> $GITHUB_OUTPUT

          # Create unit test performance summary
          cat > ../../target/ruby-unit-perf-summary.txt << EOF
          Ruby Unit Test Performance Summary
          ==================================
          Test Duration: ${DURATION} seconds
          Ruby Version: ${{ matrix.ruby-version }}
          Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Test Categories: FFI, Types, Worker
          EOF

          echo "📊 Unit test performance metrics collected"

      - name: Upload test results and performance data
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ruby-unit-test-results-${{ matrix.ruby-version }}
          path: |
            target/ruby-unit-results.xml
            target/ruby-unit-output.log
            target/ruby-unit-perf-summary.txt

      - name: Upload FFI compilation artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ruby-ffi-debug-${{ matrix.ruby-version }}
          path: |
            workers/ruby/target/debug/
            workers/ruby/ext/tasker_core/target/