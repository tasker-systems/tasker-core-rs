name: E2E Tests (All Workers)

on:
  workflow_call:

jobs:
  e2e-tests:
    name: E2E Tests (Rust + Ruby FFI Workers)
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-e2e-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Install tools
        uses: ./.github/actions/install-tools
        with:
          tools: "nextest"

      - name: Free up disk space
        run: |
          echo "ðŸ§¹ Freeing up disk space before Docker builds..."
          echo "ðŸ“Š Disk usage before cleanup:"
          df -h

          # Remove unnecessary tools and packages
          docker system prune -af --volumes
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

          echo "ðŸ“Š Disk usage after cleanup:"
          df -h

      - name: Build and start Docker services
        run: |
          echo "ðŸ³ Building and starting Docker services in parallel..."
          echo "   Disk cleanup freed ~30GB - should be sufficient for parallel builds"

          docker compose -f docker/docker-compose.test.yml up --build -d

          echo "âœ… All services started"

      - name: Wait for services with health checks
        run: |
          timeout 180 bash -c '
            echo "ðŸš€ Starting service health checks..."

            # Fast check for orchestration service
            until curl -f http://localhost:8080/health 2>/dev/null; do
              echo "â³ Waiting for orchestration service..."
              sleep 2
            done
            echo "âœ… Orchestration service ready"

            # Fast check for Rust worker
            until curl -f http://localhost:8081/health 2>/dev/null; do
              echo "â³ Waiting for Rust worker service..."
              sleep 2
            done
            echo "âœ… Rust worker ready"

            # Extended check for Ruby worker (FFI bootstrap takes time)
            echo "â³ Waiting for Ruby worker (FFI bootstrap may take 30-60 seconds)..."
            until curl -f http://localhost:8082/health 2>/dev/null; do
              echo "â³ Ruby worker still bootstrapping FFI..."
              sleep 5
            done
            echo "âœ… Ruby worker ready with FFI"

            echo "ðŸŽ‰ All services ready for E2E testing!"
          '

      - name: Validate handler discovery
        run: |
          echo "ðŸ” Validating handler discovery across all workers..."

          # Check Rust worker handlers
          rust_handler_count=$(curl -s http://localhost:8081/worker/handlers 2>/dev/null | jq 'length' 2>/dev/null || echo "0")
          echo "âœ… Rust worker handlers: $rust_handler_count"

          # Check Ruby worker handlers
          ruby_handler_count=$(curl -s http://localhost:8082/worker/handlers 2>/dev/null | jq 'length' 2>/dev/null || echo "0")
          echo "âœ… Ruby worker handlers: $ruby_handler_count"

          # Verify handlers discovered
          if [ "$ruby_handler_count" -eq "0" ]; then
            echo "âš ï¸ Warning: No Ruby handlers discovered"
          fi

      - name: Run comprehensive test suite
        run: |
          echo "ðŸ Running comprehensive test suite across all packages..."
          echo "   - Unit tests (all packages)"
          echo "   - Integration tests (lifecycle, SQL functions)"
          echo "   - E2E tests (Rust + Ruby workers)"

          # Ensure nextest output directory exists
          mkdir -p target/nextest/ci

          # Run ALL tests: unit + integration + E2E across all packages
          cargo nextest run \
            --profile ci \
            --package tasker-shared \
            --package tasker-orchestration \
            --package tasker-worker \
            --package pgmq-notify \
            --package tasker-client \
            --package tasker-core \
            --no-fail-fast
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test
          TASKER_TEST_ORCHESTRATION_URL: http://localhost:8080
          TASKER_TEST_WORKER_URL: http://localhost:8081
          TASKER_TEST_RUBY_WORKER_URL: http://localhost:8082
          RUST_LOG: info

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('target/nextest/ci/junit.xml') != ''
        with:
          name: e2e-test-results
          path: target/nextest/ci/junit.xml

      - name: Collect service logs on failure
        if: failure()
        run: |
          echo "ðŸ“‹ Collecting service logs for debugging..."
          mkdir -p docker-logs
          docker compose -f docker/docker-compose.test.yml logs postgres > docker-logs/postgres.log
          docker compose -f docker/docker-compose.test.yml logs orchestration > docker-logs/orchestration.log
          docker compose -f docker/docker-compose.test.yml logs worker > docker-logs/rust-worker.log
          docker compose -f docker/docker-compose.test.yml logs ruby-worker > docker-logs/ruby-worker.log

      - name: Upload service logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-service-logs
          path: docker-logs/

      - name: Shutdown services
        if: always()
        run: docker compose -f docker/docker-compose.test.yml down -v
