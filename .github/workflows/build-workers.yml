name: Build Workers

on:
  workflow_call:
    inputs:
      postgres-image:
        required: true
        type: string

jobs:
  build-workers:
    name: Build Worker Extensions
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_rust_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true
          working-directory: workers/ruby

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Restore Rust build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Install tools
        uses: ./.github/actions/install-tools
        with:
          tools: "sqlx-cli"

      - name: Setup database
        run: sqlx migrate run
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Build core packages (warm cache for all downstream jobs)
        run: |
          echo "üî® Building core packages to warm sccache..."
          cargo build --all-features \
            --package tasker-shared \
            --package tasker-orchestration \
            --package tasker-worker \
            --package pgmq-notify \
            --package tasker-client \
            --bins
          echo "üì¶ Verifying binaries were created..."
          ls -lh target/debug/tasker-server target/debug/tasker-worker target/debug/tasker-cli
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Build Ruby FFI extension
        run: |
          echo "üî® Building Ruby FFI extension..."
          cd workers/ruby
          bundle install
          bundle exec rake compile
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Build Python FFI extension
        run: |
          echo "üî® Building Python FFI extension..."
          cd workers/python
          uv sync --dev
          uv run maturin develop
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Build Rust worker
        run: |
          echo "üî® Building Rust worker..."
          cargo build --package tasker-worker-rust
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Verify build artifacts
        run: |
          echo "üìã Core binaries:"
          ls -lh target/debug/tasker-server target/debug/tasker-worker target/debug/tasker-cli
          echo ""
          echo "üìã Worker artifacts:"
          ls -lh target/debug/rust-worker || echo "‚ùå Rust worker missing!"
          ls -lh workers/ruby/lib/tasker_core/*.{bundle,so} 2>/dev/null || echo "‚ÑπÔ∏è  Ruby extension (expected on Linux)"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts
          path: |
            target/debug/tasker-server
            target/debug/tasker-worker
            target/debug/tasker-cli
          retention-days: 1
          if-no-files-found: error

      - name: Upload worker artifacts
        uses: actions/upload-artifact@v6
        with:
          name: worker-artifacts
          path: |
            target/debug/rust-worker
            workers/ruby/lib/tasker_core/tasker_worker_rb.bundle
            workers/ruby/lib/tasker_core/tasker_worker_rb.so
          retention-days: 1
          if-no-files-found: warn
