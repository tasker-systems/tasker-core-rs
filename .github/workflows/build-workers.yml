name: Build Workers

on:
  workflow_call:
    inputs:
      postgres-image:
        required: true
        type: string

# =============================================================================
# Multi-Job Build Strategy
# =============================================================================
# Each job runs on a fresh runner with clean disk space (~14GB available).
# This prevents "no space left on device" errors that occur when building
# all workers in a single job.
#
# Stage 1: build-core - Build Rust core packages, upload artifacts
# Stage 2: build-{ruby,python,typescript,rust} - Build each worker in parallel
#
# Artifacts flow:
#   build-core â†’ uploads core-artifacts (binaries + cargo cache info)
#   build-* â†’ downloads core cache, builds worker, uploads worker-specific artifacts
# =============================================================================

jobs:
  # ============================================================================
  # Stage 1: Build Core Packages
  # ============================================================================
  build-core:
    name: Build Core Packages
    runs-on: ubuntu-22.04
    timeout-minutes: 20

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_rust_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust build cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Install tools
        uses: ./.github/actions/install-tools
        with:
          tools: "sqlx-cli make"

      - name: Setup database
        run: sqlx migrate run
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      # NOTE: We use explicit features instead of --all-features because
      # tokio-console requires RUSTFLAGS="--cfg tokio_unstable" which we don't
      # set in CI. tokio-console is a local development tool.
      - name: Build core packages
        run: |
          echo "ðŸ”¨ Building core packages..."
          cargo build \
            --features "benchmarks,test-services" \
            --package tasker-shared \
            --package tasker-orchestration \
            --package tasker-worker \
            --package pgmq-notify \
            --package tasker-client \
            --bins
          echo "ðŸ“¦ Verifying binaries were created..."
          ls -lh target/debug/tasker-server target/debug/tasker-worker target/debug/tasker-cli
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Upload core build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: core-artifacts
          path: |
            target/debug/tasker-server
            target/debug/tasker-worker
            target/debug/tasker-cli
          retention-days: 1
          if-no-files-found: error

  # ============================================================================
  # Stage 2: Build Workers (in parallel)
  # ============================================================================

  build-ruby:
    name: Build Ruby FFI Extension
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: build-core

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_rust_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true
          working-directory: workers/ruby

      - name: Restore Rust build cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Build Ruby FFI extension
        run: |
          echo "ðŸ”¨ Building Ruby FFI extension..."
          cd workers/ruby
          bundle install
          bundle exec rake compile
        env:
          SQLX_OFFLINE: "true"

      - name: Upload Ruby extension artifact
        uses: actions/upload-artifact@v6
        with:
          name: ruby-extension
          path: |
            workers/ruby/lib/tasker_core/tasker_worker_rb.bundle
            workers/ruby/lib/tasker_core/tasker_worker_rb.so
          retention-days: 1
          if-no-files-found: warn

  build-python:
    name: Build Python FFI Extension
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: build-core

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_rust_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Restore Rust build cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Build Python FFI extension
        run: |
          echo "ðŸ”¨ Building Python FFI extension..."
          cd workers/python
          uv sync --dev
          uv run maturin develop
        env:
          SQLX_OFFLINE: "true"

      # Python extension is installed in-place via maturin develop
      # No artifact upload needed - framework tests will build it fresh

  build-typescript:
    name: Build TypeScript Worker
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: build-core

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_rust_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Restore Rust build cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Install tools
        uses: ./.github/actions/install-tools
        with:
          tools: "make"

      - name: Build TypeScript worker
        run: |
          echo "ðŸ”¨ Building TypeScript worker..."
          cd workers/typescript
          cargo make build
        env:
          SQLX_OFFLINE: "true"

      - name: Upload TypeScript artifacts
        uses: actions/upload-artifact@v6
        with:
          name: typescript-artifacts
          path: |
            workers/typescript/dist/
            target/debug/libtasker_worker.so
            target/debug/libtasker_worker.dylib
          retention-days: 1
          if-no-files-found: warn

  build-rust-worker:
    name: Build Rust Worker
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: build-core

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_rust_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust build cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Build Rust worker
        run: |
          echo "ðŸ”¨ Building Rust worker..."
          cargo build --package tasker-worker-rust
        env:
          SQLX_OFFLINE: "true"

      - name: Upload Rust worker artifact
        uses: actions/upload-artifact@v6
        with:
          name: rust-worker-artifact
          path: target/debug/rust-worker
          retention-days: 1
          if-no-files-found: warn
