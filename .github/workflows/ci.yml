name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  docker-build:
    uses: ./.github/workflows/build-docker-images.yml

  code-quality:
    needs: docker-build
    uses: ./.github/workflows/code-quality.yml
    with:
      postgres-image: ${{ needs.docker-build.outputs.postgres-image }}

  unit-tests:
    needs: docker-build
    uses: ./.github/workflows/test-unit.yml
    with:
      postgres-image: ${{ needs.docker-build.outputs.postgres-image }}

  # Unified E2E tests - covers all integration scenarios (Rust + Ruby workers)
  e2e-tests:
    needs: [code-quality, unit-tests]
    uses: ./.github/workflows/test-e2e.yml

  # Ruby unit tests (fast, no Docker)
  ruby-unit-tests:
    needs: docker-build
    uses: ./.github/workflows/test-ruby-unit.yml

  # Ruby framework tests (FFI, types, events - no Docker)
  ruby-framework-tests:
    needs: docker-build
    uses: ./.github/workflows/test-ruby-framework.yml

  performance-analysis:
    needs: [e2e-tests, ruby-framework-tests, ruby-unit-tests]
    runs-on: ubuntu-22.04
    if: always()
    steps:
      - name: Download Ruby performance artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ruby-*-test-results*
          merge-multiple: true
          path: performance-data/
        continue-on-error: true

      - name: Aggregate performance metrics
        run: |
          echo "ðŸ“Š Aggregating Ruby test performance metrics..."

          # Create performance dashboard
          cat > performance-summary.md << 'EOF'
          # Ruby Test Performance Summary

          ## Overview
          This report summarizes performance metrics from Ruby unit and integration tests.

          EOF

          # Process unit test performance
          if [ -f "performance-data/ruby-unit-perf-summary.txt" ]; then
            echo "## Unit Test Performance" >> performance-summary.md
            echo '```' >> performance-summary.md
            cat performance-data/ruby-unit-perf-summary.txt >> performance-summary.md
            echo '```' >> performance-summary.md
            echo "" >> performance-summary.md
          fi

          # Process integration test performance
          if [ -f "performance-data/ruby-integration-perf-summary.txt" ]; then
            echo "## Integration Test Performance" >> performance-summary.md
            echo '```' >> performance-summary.md
            cat performance-data/ruby-integration-perf-summary.txt >> performance-summary.md
            echo '```' >> performance-summary.md
            echo "" >> performance-summary.md
          fi

          # Add Docker stats if available
          if [ -f "performance-data/ruby-integration-docker-stats.log" ]; then
            echo "## Docker Service Performance" >> performance-summary.md
            echo '```' >> performance-summary.md
            cat performance-data/ruby-integration-docker-stats.log >> performance-summary.md
            echo '```' >> performance-summary.md
          fi

          echo "âœ… Performance summary created"

      - name: Upload performance analysis
        uses: actions/upload-artifact@v4
        with:
          name: ruby-performance-analysis
          path: |
            performance-summary.md
            performance-data/

  ci-success:
    needs: [e2e-tests, ruby-framework-tests, performance-analysis]
    uses: ./.github/workflows/ci-success.yml
