name: Integration Tests

on:
  workflow_call:
    inputs:
      postgres-image:
        required: true
        type: string

jobs:
  # ============================================================================
  # Stage 1: Workspace Compile
  # Build core packages and warm sccache for all downstream jobs
  # ============================================================================
  workspace-compile:
    name: Workspace Compile
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_rust_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Install tools
        uses: ./.github/actions/install-tools
        with:
          tools: "nextest sqlx-cli"

      - name: Setup database
        run: sqlx migrate run
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Build core packages
        run: |
          echo "üî® Building core packages to warm sccache..."
          cargo build --all-features \
            --package tasker-shared \
            --package tasker-orchestration \
            --package tasker-worker \
            --package pgmq-notify \
            --package tasker-client \
            --bins
          echo "üì¶ Verifying binaries were created..."
          ls -lh target/debug/tasker-server target/debug/tasker-worker target/debug/tasker-cli
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Create nextest archive
        run: |
          echo "üì¶ Creating nextest archive for test partitioning..."
          cargo nextest archive \
            --archive-file nextest-archive.tar.zst \
            --workspace \
            --all-features
          ls -lh nextest-archive.tar.zst
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-artifacts
          path: |
            target/debug/tasker-server
            target/debug/tasker-worker
            target/debug/tasker-cli
            target/debug/rust-worker
          retention-days: 1
          if-no-files-found: error

      - name: Upload nextest archive
        uses: actions/upload-artifact@v5
        with:
          name: nextest-archive
          path: nextest-archive.tar.zst
          retention-days: 1

  # ============================================================================
  # Stage 2a: Unit Tests (parallel with build-workers)
  # Run library tests and doctests for core packages
  # ============================================================================
  unit-tests:
    name: Unit Tests + Doctests
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    needs: workspace-compile

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_rust_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Install tools
        uses: ./.github/actions/install-tools
        with:
          tools: "nextest sqlx-cli"

      - name: Setup database
        run: sqlx migrate run
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Run unit tests
        run: |
          echo "üß™ Running unit tests..."
          mkdir -p target/nextest/ci
          cargo nextest run \
            --profile ci \
            --lib \
            --package tasker-shared \
            --package tasker-orchestration \
            --package tasker-worker \
            --package pgmq-notify \
            --package tasker-client \
            --no-fail-fast
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Run doctests
        run: |
          echo "üìö Running documentation tests..."
          cargo test --doc \
            --package tasker-shared \
            --package tasker-orchestration \
            --package tasker-worker \
            --package pgmq-notify \
            --package tasker-client
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Upload unit test results
        uses: actions/upload-artifact@v5
        if: always() && hashFiles('target/nextest/ci/junit.xml') != ''
        with:
          name: unit-test-results
          path: target/nextest/ci/junit.xml

  # ============================================================================
  # Stage 2b: Build Workers (parallel with unit-tests)
  # Build FFI extensions for Ruby and Python workers
  # ============================================================================
  build-workers:
    name: Build Workers (FFI)
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: workspace-compile

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_rust_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true
          working-directory: workers/ruby

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Restore Rust build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features native-tls,postgres --locked
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Setup database
        run: sqlx migrate run
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Build Ruby FFI extension
        run: |
          echo "üî® Building Ruby FFI extension..."
          cd workers/ruby
          bundle install
          bundle exec rake compile
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Build Python FFI extension
        run: |
          echo "üî® Building Python FFI extension..."
          cd workers/python
          uv sync --dev
          uv run maturin develop
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Build Rust worker
        run: |
          echo "üî® Building Rust worker..."
          cargo build --package rust-worker --all-features
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Verify worker artifacts
        run: |
          echo "üìã Worker artifacts:"
          ls -lh target/debug/rust-worker || echo "‚ùå Rust worker missing!"
          ls -lh workers/ruby/lib/tasker_core/*.{bundle,so} 2>/dev/null || echo "‚ÑπÔ∏è  Ruby extension (expected on Linux)"
          ls -lh workers/python/.venv/lib/python*/site-packages/tasker_core*.so 2>/dev/null || echo "‚ÑπÔ∏è  Python extension in venv"

      - name: Upload worker artifacts
        uses: actions/upload-artifact@v5
        with:
          name: worker-artifacts
          path: |
            target/debug/rust-worker
            workers/ruby/lib/tasker_core/tasker_worker_rb.bundle
            workers/ruby/lib/tasker_core/tasker_worker_rb.so
          retention-days: 1
          if-no-files-found: warn

  # ============================================================================
  # Stage 3: Integration Tests (partitioned)
  # Run E2E tests with all services running
  # ============================================================================
  integration-tests:
    name: Integration Tests (${{ matrix.partition }}/2)
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: [build-workers, unit-tests]
    strategy:
      fail-fast: false
      matrix:
        partition: [1, 2]

    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_rust_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true
          working-directory: workers/ruby

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Restore Rust build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          name: build-artifacts
          path: artifacts/build

      - name: Download worker artifacts
        uses: actions/download-artifact@v6
        with:
          name: worker-artifacts
          path: artifacts/workers
        continue-on-error: true

      - name: Download nextest archive
        uses: actions/download-artifact@v6
        with:
          name: nextest-archive
          path: .

      - name: Restore artifacts to correct locations
        run: |
          echo "üì¶ Restoring build artifacts..."

          # Restore core binaries
          mkdir -p target/debug
          if [ -d artifacts/build/target/debug ]; then
            cp -rf artifacts/build/target/debug/* target/debug/
          elif [ -d artifacts/build ]; then
            # Flat structure
            cp -f artifacts/build/tasker-* target/debug/ 2>/dev/null || true
            cp -f artifacts/build/rust-worker target/debug/ 2>/dev/null || true
          fi
          echo "‚úÖ Core binaries restored"
          ls -lh target/debug/tasker-server target/debug/tasker-worker target/debug/tasker-cli 2>/dev/null || echo "‚ö†Ô∏è  Some binaries missing"

          # Restore Ruby extension
          if [ -d artifacts/workers/workers/ruby/lib/tasker_core ]; then
            mkdir -p workers/ruby/lib/tasker_core
            cp -rf artifacts/workers/workers/ruby/lib/tasker_core/* workers/ruby/lib/tasker_core/
            echo "‚úÖ Ruby extension restored"
          elif [ -d artifacts/workers ]; then
            mkdir -p workers/ruby/lib/tasker_core
            cp -f artifacts/workers/*.so workers/ruby/lib/tasker_core/ 2>/dev/null || true
            cp -f artifacts/workers/*.bundle workers/ruby/lib/tasker_core/ 2>/dev/null || true
          fi

          # Restore Rust worker
          if [ -f artifacts/workers/target/debug/rust-worker ]; then
            cp -f artifacts/workers/target/debug/rust-worker target/debug/
          elif [ -f artifacts/workers/rust-worker ]; then
            cp -f artifacts/workers/rust-worker target/debug/
          fi

      - name: Make binaries executable
        run: |
          chmod +x target/debug/tasker-server target/debug/tasker-worker target/debug/tasker-cli 2>/dev/null || true
          chmod +x target/debug/rust-worker 2>/dev/null || true

      - name: Build Python FFI extension
        run: |
          cd workers/python
          uv sync --dev
          uv run maturin develop
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Install tools
        uses: ./.github/actions/install-tools
        with:
          tools: "nextest sqlx-cli"

      - name: Run database migrations
        run: sqlx migrate run
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Generate test configuration
        run: |
          mkdir -p config/tasker
          echo "üîß Generating orchestration configuration..."
          cargo run --package tasker-client --bin tasker-cli -- config generate \
            --context orchestration \
            --environment test \
            --source-dir config/tasker \
            --output config/tasker/orchestration-test.toml
          echo "üîß Generating worker configuration..."
          cargo run --package tasker-client --bin tasker-cli -- config generate \
            --context worker \
            --environment test \
            --source-dir config/tasker \
            --output config/tasker/worker-test.toml
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Start native services
        run: |
          mkdir -p .pids
          chmod +x .github/scripts/start-native-services.sh
          .github/scripts/start-native-services.sh
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Run integration tests (partition ${{ matrix.partition }}/2)
        run: |
          echo "üèÅ Running integration tests - partition ${{ matrix.partition }} of 2..."
          mkdir -p target/nextest/ci
          cargo nextest run \
            --archive-file nextest-archive.tar.zst \
            --profile ci \
            --partition count:${{ matrix.partition }}/2 \
            --test '*' \
            --no-fail-fast
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test
          TASKER_TEST_ORCHESTRATION_URL: http://localhost:8080
          TASKER_TEST_WORKER_URL: http://localhost:8081
          TASKER_TEST_RUBY_WORKER_URL: http://localhost:8082
          TASKER_TEST_PYTHON_WORKER_URL: http://localhost:8083
          TASKER_FIXTURE_PATH: ${{ github.workspace }}/tests/fixtures
          RUST_LOG: info

      - name: Upload integration test results
        uses: actions/upload-artifact@v5
        if: always() && hashFiles('target/nextest/ci/junit.xml') != ''
        with:
          name: integration-test-results-${{ matrix.partition }}
          path: target/nextest/ci/junit.xml

      - name: Collect service logs on failure
        if: failure()
        run: |
          mkdir -p service-logs
          [ -f orchestration.log ] && cp orchestration.log service-logs/
          [ -f worker.log ] && cp worker.log service-logs/
          [ -f ruby-worker.log ] && cp ruby-worker.log service-logs/
          [ -f python-worker.log ] && cp python-worker.log service-logs/

      - name: Upload service logs
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: service-logs-${{ matrix.partition }}
          path: service-logs/

      - name: Stop native services
        if: always()
        run: |
          chmod +x .github/scripts/stop-native-services.sh
          .github/scripts/stop-native-services.sh
