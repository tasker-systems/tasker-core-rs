name: "Install Build Tools"
description: "Installs cargo-binstall and common tools used across CI workflows"
author: "Tasker Systems"

inputs:
  tools:
    description: "Space-separated list of tools to install (nextest, sqlx-cli, audit, llvm-cov)"
    required: false
    default: "sqlx-cli"

runs:
  using: "composite"
  steps:
    - name: Cache cargo tools
      uses: actions/cache@v4
      id: cargo-tools-cache
      with:
        path: ~/.cargo/bin
        key: cargo-tools-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-${{ inputs.tools }}
        restore-keys: |
          cargo-tools-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-
          cargo-tools-${{ runner.os }}-
    - name: Install cargo-binstall
      if: steps.cargo-tools-cache.outputs.cache-hit != 'true'
      uses: cargo-bins/cargo-binstall@main

    - name: Add cargo bin to PATH
      shell: bash
      run: |
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Verify tools after cache restore
      if: steps.cargo-tools-cache.outputs.cache-hit == 'true'
      shell: bash
      run: |
        echo "ðŸ“‹ Verifying cached tools..."

        # Check each tool based on what was requested
        if echo "${{ inputs.tools }}" | grep -q "nextest"; then
          if command -v cargo-nextest &> /dev/null; then
            echo "âœ… cargo-nextest available from cache ($(cargo-nextest --version | head -n1))"
          else
            echo "âš ï¸ cargo-nextest not found in cache"
          fi
        fi

        if echo "${{ inputs.tools }}" | grep -q "sqlx-cli"; then
          if command -v sqlx &> /dev/null; then
            echo "âœ… sqlx-cli available from cache ($(sqlx --version))"
          else
            echo "âš ï¸ sqlx-cli not found in cache"
          fi
        fi

        if echo "${{ inputs.tools }}" | grep -q "audit"; then
          if command -v cargo-audit &> /dev/null; then
            echo "âœ… cargo-audit available from cache ($(cargo-audit --version))"
          else
            echo "âš ï¸ cargo-audit not found in cache"
          fi
        fi

        if echo "${{ inputs.tools }}" | grep -q "make"; then
          if command -v cargo-make &> /dev/null; then
            echo "âœ… cargo-make available from cache ($(cargo-make --version))"
          else
            echo "âš ï¸ cargo-make not found in cache"
          fi
        fi

        if echo "${{ inputs.tools }}" | grep -q "llvm-cov"; then
          if command -v cargo-llvm-cov &> /dev/null; then
            echo "âœ… cargo-llvm-cov available from cache ($(cargo-llvm-cov --version))"
          else
            echo "âš ï¸ cargo-llvm-cov not found in cache"
          fi
        fi

    - name: Install requested tools
      if: steps.cargo-tools-cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        echo "ðŸ”§ Installing tools: ${{ inputs.tools }}"

        # Install tools using proven working commands with existence checks
        if echo "${{ inputs.tools }}" | grep -q "nextest"; then
          if command -v cargo-nextest &> /dev/null; then
            echo "âœ… cargo-nextest already installed ($(cargo-nextest --version | head -n1))"
          else
            echo "Installing cargo-nextest with binstall --secure..."
            if ! cargo binstall cargo-nextest --secure -y; then
              echo "âŒ Failed to install cargo-nextest"
              exit 1
            fi
            echo "âœ… cargo-nextest installed successfully"
          fi
        fi

        if echo "${{ inputs.tools }}" | grep -q "sqlx-cli"; then
          if command -v sqlx &> /dev/null; then
            echo "âœ… sqlx-cli already installed ($(sqlx --version))"
          else
            echo "Installing sqlx-cli with cargo install..."
            if ! cargo install sqlx-cli --no-default-features --features native-tls,postgres; then
              echo "âŒ Failed to install sqlx-cli"
              exit 1
            fi
            echo "âœ… sqlx-cli installed successfully"
          fi
        fi

        if echo "${{ inputs.tools }}" | grep -q "audit"; then
          if command -v cargo-audit &> /dev/null; then
            echo "âœ… cargo-audit already installed ($(cargo-audit --version))"
          else
            echo "Installing cargo-audit with cargo install --locked..."
            if ! cargo install cargo-audit --locked; then
              echo "âŒ Failed to install cargo-audit"
              exit 1
            fi
            echo "âœ… cargo-audit installed successfully"
          fi
        fi

        if echo "${{ inputs.tools }}" | grep -q "make"; then
          if command -v cargo-make &> /dev/null; then
            echo "âœ… cargo-make already installed ($(cargo-make --version))"
          else
            # Use cargo install instead of binstall to avoid GLIBC version mismatch
            # Pre-built binaries require GLIBC 2.38+ but Ubuntu 22.04 has GLIBC 2.35
            echo "Installing cargo-make with cargo install..."
            if ! cargo install cargo-make; then
              echo "âŒ Failed to install cargo-make"
              exit 1
            fi
            echo "âœ… cargo-make installed successfully"
          fi
        fi

        if echo "${{ inputs.tools }}" | grep -q "llvm-cov"; then
          if command -v cargo-llvm-cov &> /dev/null; then
            echo "âœ… cargo-llvm-cov already installed ($(cargo-llvm-cov --version))"
          else
            echo "Installing cargo-llvm-cov with binstall..."
            if ! cargo binstall cargo-llvm-cov -y; then
              echo "âŒ Failed to install cargo-llvm-cov"
              exit 1
            fi
            echo "âœ… cargo-llvm-cov installed successfully"
          fi
        fi

        echo "âœ… All tool installations complete"

    - name: Display installed tools
      shell: bash
      run: |
        echo "ðŸ“‹ Installed tool versions:"
        if command -v cargo-nextest &> /dev/null; then
          echo "- cargo-nextest: $(cargo nextest --version | head -n1)"
        fi
        if command -v sqlx &> /dev/null; then
          echo "- sqlx-cli: $(sqlx --version)"
        fi
        if command -v cargo-audit &> /dev/null; then
          echo "- cargo-audit: $(cargo audit --version)"
        fi
        if command -v cargo-make &> /dev/null; then
          echo "- cargo-make: $(cargo make --version)"
        fi
        if command -v cargo-llvm-cov &> /dev/null; then
          echo "- cargo-llvm-cov: $(cargo llvm-cov --version)"
        fi
