{
  "openapi": "3.1.0",
  "info": {
    "title": "Tasker Worker API",
    "description": "REST API for the Tasker worker process",
    "contact": {
      "name": "Tasker Systems",
      "email": "support@tasker-systems.com"
    },
    "license": {
      "name": "MIT",
      "url": "https://opensource.org/licenses/MIT"
    },
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "/",
      "description": "Worker API"
    }
  ],
  "paths": {
    "/config": {
      "get": {
        "tags": [
          "config"
        ],
        "summary": "Get complete worker configuration: GET /config",
        "description": "Returns the complete worker configuration including both common (shared) and\nworker-specific settings with sensitive values redacted. This provides a unified\nview of the deployed worker system configuration in a single response.\n\nThe response includes:\n- `common`: Shared configuration (database, circuit breakers, telemetry, etc.)\n- `worker`: Worker-specific configuration (template paths, handler discovery, etc.)\n- `metadata`: Response metadata including which fields were redacted for transparency\n\nThis design makes it easy to compare configurations across systems and debug\ndeployment issues with a single curl command.",
        "operationId": "get_config",
        "responses": {
          "200": {
            "description": "Complete worker configuration (secrets redacted)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WorkerConfigResponse"
                }
              }
            }
          },
          "401": {
            "description": "Authentication required",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          },
          "403": {
            "description": "Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          },
          "500": {
            "description": "Failed to retrieve configuration",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          }
        },
        "security": [
          {
            "bearer_auth": []
          },
          {
            "api_key_auth": []
          }
        ]
      }
    },
    "/health": {
      "get": {
        "tags": [
          "health"
        ],
        "summary": "Basic health check endpoint: GET /health",
        "description": "Simple health check that returns OK if the worker service is running.\nAlways available, even during graceful shutdown.",
        "operationId": "health_check",
        "responses": {
          "200": {
            "description": "Worker is running",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BasicHealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/health/detailed": {
      "get": {
        "tags": [
          "health"
        ],
        "summary": "Comprehensive health check: GET /health/detailed",
        "description": "Detailed health information about all worker subsystems.\nIncludes performance metrics and diagnostic information.",
        "operationId": "detailed_health_check",
        "responses": {
          "200": {
            "description": "Detailed health information",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DetailedHealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/health/live": {
      "get": {
        "tags": [
          "health"
        ],
        "summary": "Kubernetes liveness probe: GET /health/live",
        "description": "Indicates whether the worker is alive and should not be restarted.\nSimple check focusing on basic process responsiveness.",
        "operationId": "liveness_check",
        "responses": {
          "200": {
            "description": "Worker is alive",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BasicHealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/health/ready": {
      "get": {
        "tags": [
          "health"
        ],
        "summary": "Kubernetes readiness probe: GET /health/ready",
        "description": "Indicates whether the worker is ready to process steps.\nChecks database connectivity, command processor status, and queue health.",
        "operationId": "readiness_check",
        "responses": {
          "200": {
            "description": "Worker is ready",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DetailedHealthResponse"
                }
              }
            }
          },
          "503": {
            "description": "Worker is not ready"
          }
        }
      }
    },
    "/templates": {
      "get": {
        "tags": [
          "templates"
        ],
        "summary": "List supported templates and namespaces",
        "description": "GET /templates",
        "operationId": "list_templates",
        "parameters": [
          {
            "name": "namespace",
            "in": "query",
            "description": "Filter by namespace",
            "required": false,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "include_cache_stats",
            "in": "query",
            "description": "Include cache statistics",
            "required": false,
            "schema": {
              "type": "boolean"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "List of templates",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TemplateListResponse"
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Insufficient permissions"
          }
        },
        "security": [
          {
            "bearer_auth": []
          },
          {
            "api_key_auth": []
          }
        ]
      }
    },
    "/templates/cache": {
      "delete": {
        "tags": [
          "templates"
        ],
        "summary": "Clear template cache",
        "description": "DELETE /templates/cache",
        "operationId": "clear_cache",
        "responses": {
          "200": {
            "description": "Cache cleared",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CacheOperationResponse"
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Insufficient permissions"
          }
        },
        "security": [
          {
            "bearer_auth": []
          },
          {
            "api_key_auth": []
          }
        ]
      }
    },
    "/templates/cache/maintain": {
      "post": {
        "tags": [
          "templates"
        ],
        "summary": "Perform cache maintenance",
        "description": "POST /templates/cache/maintain",
        "operationId": "maintain_cache",
        "responses": {
          "200": {
            "description": "Maintenance completed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CacheOperationResponse"
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Insufficient permissions"
          }
        },
        "security": [
          {
            "bearer_auth": []
          },
          {
            "api_key_auth": []
          }
        ]
      }
    },
    "/templates/cache/stats": {
      "get": {
        "tags": [
          "templates"
        ],
        "summary": "Get cache statistics",
        "description": "GET /templates/cache/stats",
        "operationId": "get_cache_stats",
        "responses": {
          "200": {
            "description": "Cache statistics",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CacheStats"
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Insufficient permissions"
          }
        },
        "security": [
          {
            "bearer_auth": []
          },
          {
            "api_key_auth": []
          }
        ]
      }
    },
    "/templates/{namespace}/{name}/{version}": {
      "get": {
        "tags": [
          "templates"
        ],
        "summary": "Get a specific task template",
        "description": "GET /templates/{namespace}/{name}/{version}",
        "operationId": "get_template",
        "parameters": [
          {
            "name": "namespace",
            "in": "path",
            "description": "Template namespace",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "name",
            "in": "path",
            "description": "Template name",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "version",
            "in": "path",
            "description": "Template version",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Template details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TemplateResponse"
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Insufficient permissions"
          },
          "404": {
            "description": "Template not found"
          }
        },
        "security": [
          {
            "bearer_auth": []
          },
          {
            "api_key_auth": []
          }
        ]
      }
    },
    "/templates/{namespace}/{name}/{version}/refresh": {
      "post": {
        "tags": [
          "templates"
        ],
        "summary": "Refresh specific template in cache",
        "description": "POST /templates/{namespace}/{name}/{version}/refresh",
        "operationId": "refresh_template",
        "parameters": [
          {
            "name": "namespace",
            "in": "path",
            "description": "Template namespace",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "name",
            "in": "path",
            "description": "Template name",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "version",
            "in": "path",
            "description": "Template version",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Template refreshed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CacheOperationResponse"
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Insufficient permissions"
          },
          "500": {
            "description": "Refresh failed"
          }
        },
        "security": [
          {
            "bearer_auth": []
          },
          {
            "api_key_auth": []
          }
        ]
      }
    },
    "/templates/{namespace}/{name}/{version}/validate": {
      "post": {
        "tags": [
          "templates"
        ],
        "summary": "Validate a template for worker execution",
        "description": "POST /templates/{namespace}/{name}/{version}/validate",
        "operationId": "validate_template",
        "parameters": [
          {
            "name": "namespace",
            "in": "path",
            "description": "Template namespace",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "name",
            "in": "path",
            "description": "Template name",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "version",
            "in": "path",
            "description": "Template version",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Validation result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TemplateValidationResponse"
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Insufficient permissions"
          },
          "404": {
            "description": "Template not found"
          }
        },
        "security": [
          {
            "bearer_auth": []
          },
          {
            "api_key_auth": []
          }
        ]
      }
    }
  },
  "components": {
    "schemas": {
      "ApiError": {
        "oneOf": [
          {
            "type": "object",
            "required": [
              "NotFound"
            ],
            "properties": {
              "NotFound": {
                "type": "object",
                "required": [
                  "message"
                ],
                "properties": {
                  "message": {
                    "type": "string"
                  }
                }
              }
            }
          },
          {
            "type": "string",
            "enum": [
              "Forbidden"
            ]
          },
          {
            "type": "string",
            "enum": [
              "Unauthorized"
            ]
          },
          {
            "type": "object",
            "required": [
              "BadRequest"
            ],
            "properties": {
              "BadRequest": {
                "type": "object",
                "required": [
                  "message"
                ],
                "properties": {
                  "message": {
                    "type": "string"
                  }
                }
              }
            }
          },
          {
            "type": "object",
            "description": "TAS-154: Conflict - resource already exists (e.g., duplicate identity hash)",
            "required": [
              "Conflict"
            ],
            "properties": {
              "Conflict": {
                "type": "object",
                "description": "TAS-154: Conflict - resource already exists (e.g., duplicate identity hash)",
                "required": [
                  "message"
                ],
                "properties": {
                  "message": {
                    "type": "string"
                  }
                }
              }
            }
          },
          {
            "type": "string",
            "enum": [
              "ServiceUnavailable"
            ]
          },
          {
            "type": "string",
            "enum": [
              "Timeout"
            ]
          },
          {
            "type": "string",
            "enum": [
              "CircuitBreakerOpen"
            ]
          },
          {
            "type": "object",
            "description": "TAS-75: System backpressure active - includes Retry-After header",
            "required": [
              "Backpressure"
            ],
            "properties": {
              "Backpressure": {
                "type": "object",
                "description": "TAS-75: System backpressure active - includes Retry-After header",
                "required": [
                  "reason",
                  "retry_after_seconds"
                ],
                "properties": {
                  "reason": {
                    "type": "string"
                  },
                  "retry_after_seconds": {
                    "type": "integer",
                    "format": "int64",
                    "minimum": 0
                  }
                }
              }
            }
          },
          {
            "type": "object",
            "required": [
              "DatabaseError"
            ],
            "properties": {
              "DatabaseError": {
                "type": "object",
                "required": [
                  "operation"
                ],
                "properties": {
                  "operation": {
                    "type": "string"
                  }
                }
              }
            }
          },
          {
            "type": "object",
            "required": [
              "AuthenticationError"
            ],
            "properties": {
              "AuthenticationError": {
                "type": "object",
                "required": [
                  "reason"
                ],
                "properties": {
                  "reason": {
                    "type": "string"
                  }
                }
              }
            }
          },
          {
            "type": "object",
            "required": [
              "AuthorizationError"
            ],
            "properties": {
              "AuthorizationError": {
                "type": "object",
                "required": [
                  "reason"
                ],
                "properties": {
                  "reason": {
                    "type": "string"
                  }
                }
              }
            }
          },
          {
            "type": "object",
            "required": [
              "InvalidUuid"
            ],
            "properties": {
              "InvalidUuid": {
                "type": "object",
                "required": [
                  "uuid"
                ],
                "properties": {
                  "uuid": {
                    "type": "string"
                  }
                }
              }
            }
          },
          {
            "type": "string",
            "enum": [
              "JsonError"
            ]
          },
          {
            "type": "string",
            "enum": [
              "Internal"
            ]
          }
        ],
        "description": "Web API specific errors with HTTP status code mappings"
      },
      "BasicHealthResponse": {
        "type": "object",
        "description": "Basic health check response",
        "required": [
          "status",
          "timestamp",
          "worker_id"
        ],
        "properties": {
          "status": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "worker_id": {
            "type": "string"
          }
        }
      },
      "CacheOperationResponse": {
        "type": "object",
        "description": "Response for cache operations",
        "required": [
          "operation",
          "success",
          "cache_stats"
        ],
        "properties": {
          "cache_stats": {
            "$ref": "#/components/schemas/CacheStats"
          },
          "operation": {
            "type": "string"
          },
          "success": {
            "type": "boolean"
          }
        }
      },
      "CacheStats": {
        "type": "object",
        "description": "Statistics about the task template cache",
        "required": [
          "total_cached",
          "cache_hits",
          "cache_misses",
          "cache_evictions",
          "oldest_entry_age_seconds",
          "average_access_count",
          "supported_namespaces"
        ],
        "properties": {
          "average_access_count": {
            "type": "number",
            "format": "double"
          },
          "cache_evictions": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "cache_hits": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "cache_misses": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "oldest_entry_age_seconds": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "supported_namespaces": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "total_cached": {
            "type": "integer",
            "minimum": 0
          }
        }
      },
      "ConfigMetadata": {
        "type": "object",
        "description": "Metadata about the configuration response",
        "required": [
          "timestamp",
          "source",
          "redacted_fields"
        ],
        "properties": {
          "redacted_fields": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "source": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "DetailedHealthResponse": {
        "type": "object",
        "description": "Detailed health check response with subsystem checks",
        "required": [
          "status",
          "timestamp",
          "worker_id",
          "checks",
          "system_info"
        ],
        "properties": {
          "checks": {
            "type": "object"
          },
          "status": {
            "type": "string"
          },
          "system_info": {
            "$ref": "#/components/schemas/WorkerSystemInfo"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "worker_id": {
            "type": "string"
          }
        }
      },
      "HandlerMetadata": {
        "type": "object",
        "description": "Handler metadata for registry",
        "required": [
          "namespace",
          "name",
          "version",
          "handler_class",
          "registered_at"
        ],
        "properties": {
          "config_schema": {},
          "default_dependent_system": {
            "type": [
              "string",
              "null"
            ]
          },
          "handler_class": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "namespace": {
            "type": "string"
          },
          "registered_at": {
            "type": "string",
            "format": "date-time"
          },
          "version": {
            "type": "string"
          }
        }
      },
      "PoolDetail": {
        "type": "object",
        "description": "Detailed metrics for a single connection pool (TAS-164)",
        "required": [
          "active_connections",
          "idle_connections",
          "max_connections",
          "utilization_percent",
          "total_acquires",
          "slow_acquires",
          "acquire_errors",
          "average_acquire_time_ms",
          "max_acquire_time_ms"
        ],
        "properties": {
          "acquire_errors": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "active_connections": {
            "type": "integer",
            "format": "int32",
            "minimum": 0
          },
          "average_acquire_time_ms": {
            "type": "number",
            "format": "double"
          },
          "idle_connections": {
            "type": "integer",
            "format": "int32",
            "minimum": 0
          },
          "max_acquire_time_ms": {
            "type": "number",
            "format": "double"
          },
          "max_connections": {
            "type": "integer",
            "format": "int32",
            "minimum": 0
          },
          "slow_acquires": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "total_acquires": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "utilization_percent": {
            "type": "number",
            "format": "double"
          }
        }
      },
      "PoolUtilizationInfo": {
        "type": "object",
        "description": "Connection pool utilization information (TAS-164)\n\nShared between orchestration and worker health responses.\nEach service instance reports its own pool utilization.",
        "required": [
          "tasker_pool",
          "pgmq_pool"
        ],
        "properties": {
          "pgmq_pool": {
            "$ref": "#/components/schemas/PoolDetail"
          },
          "tasker_pool": {
            "$ref": "#/components/schemas/PoolDetail"
          }
        }
      },
      "TemplateListResponse": {
        "type": "object",
        "description": "Response for template listing",
        "required": [
          "supported_namespaces",
          "template_count",
          "worker_capabilities"
        ],
        "properties": {
          "cache_stats": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/CacheStats"
              }
            ]
          },
          "supported_namespaces": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "template_count": {
            "type": "integer",
            "minimum": 0
          },
          "worker_capabilities": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      },
      "TemplateResponse": {
        "type": "object",
        "description": "Response for template retrieval",
        "required": [
          "template",
          "handler_metadata",
          "cached"
        ],
        "properties": {
          "access_count": {
            "type": [
              "integer",
              "null"
            ],
            "format": "int64",
            "minimum": 0
          },
          "cache_age_seconds": {
            "type": [
              "integer",
              "null"
            ],
            "format": "int64",
            "minimum": 0
          },
          "cached": {
            "type": "boolean"
          },
          "handler_metadata": {
            "$ref": "#/components/schemas/HandlerMetadata"
          },
          "template": {
            "type": "object"
          }
        }
      },
      "TemplateValidationResponse": {
        "type": "object",
        "description": "Response for template validation",
        "required": [
          "valid",
          "errors",
          "required_capabilities",
          "step_handlers"
        ],
        "properties": {
          "errors": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "required_capabilities": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "step_handlers": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "valid": {
            "type": "boolean"
          }
        }
      },
      "Value": {},
      "WorkerConfigResponse": {
        "type": "object",
        "description": "Unified worker configuration response with both common and worker-specific config\n\nThis provides a complete view of the worker system's configuration in a single response,\nmaking it easier for operators to understand the full deployment without multiple API calls.",
        "required": [
          "environment",
          "common",
          "worker",
          "metadata"
        ],
        "properties": {
          "common": {
            "$ref": "#/components/schemas/Value",
            "description": "Common (shared) configuration components"
          },
          "environment": {
            "type": "string"
          },
          "metadata": {
            "$ref": "#/components/schemas/ConfigMetadata"
          },
          "worker": {
            "$ref": "#/components/schemas/Value",
            "description": "Worker-specific configuration"
          }
        }
      },
      "WorkerSystemInfo": {
        "type": "object",
        "description": "Worker system information",
        "required": [
          "version",
          "environment",
          "uptime_seconds",
          "worker_type",
          "database_pool_size",
          "command_processor_active",
          "supported_namespaces"
        ],
        "properties": {
          "command_processor_active": {
            "type": "boolean"
          },
          "database_pool_size": {
            "type": "integer",
            "format": "int32",
            "minimum": 0
          },
          "environment": {
            "type": "string"
          },
          "pool_utilization": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/PoolUtilizationInfo",
                "description": "Connection pool utilization details (TAS-164)"
              }
            ]
          },
          "supported_namespaces": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "uptime_seconds": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "version": {
            "type": "string"
          },
          "worker_type": {
            "type": "string"
          }
        }
      }
    },
    "securitySchemes": {
      "api_key_auth": {
        "type": "apiKey",
        "in": "header",
        "name": "X-API-Key"
      },
      "bearer_auth": {
        "type": "http",
        "scheme": "bearer"
      }
    }
  },
  "tags": [
    {
      "name": "health",
      "description": "Health check and monitoring"
    },
    {
      "name": "templates",
      "description": "Task template management and cache operations"
    },
    {
      "name": "config",
      "description": "Runtime configuration observability (secrets redacted)"
    }
  ]
}
