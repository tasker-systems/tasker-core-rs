# =============================================================================
# Tasker TypeScript Worker - cargo-make Task Definitions
# =============================================================================
#
# This file defines build, test, and quality tasks for the TypeScript worker.
# Uses Bun for package management and Biome for linting.
#
# Usage:
#   cargo make check       # Run all checks (lint, typecheck, test)
#   cargo make build       # Build FFI + TypeScript
#   cargo make test        # Run tests
#   cargo make fix         # Auto-fix linting issues
#
# =============================================================================

[config]
default_to_workspace = false
skip_core_tasks = true

[env]
# Respect CARGO_TARGET_DIR if set, otherwise use workspace default
TARGET_DIR = { value = "../../target", condition = { env_not_set = ["CARGO_TARGET_DIR"] } }

# =============================================================================
# Composite Tasks
# =============================================================================

[tasks.default]
description = "Default: run all checks"
alias = "check"

[tasks.check]
description = "Run all quality checks (lint, typecheck, test)"
dependencies = ["lint", "typecheck", "test"]

[tasks.build]
description = "Build FFI library and TypeScript package (includes binding generation)"
dependencies = ["generate-bindings", "build-ffi", "build-ts"]

[tasks.fix]
description = "Auto-fix all fixable issues"
dependencies = ["format-fix", "lint-fix"]

# =============================================================================
# Setup Tasks
# =============================================================================

[tasks.install]
description = "Install npm dependencies"
script = '''
if [ ! -d "node_modules" ] || [ "package.json" -nt "node_modules" ]; then
    echo "üì¶ Installing dependencies..."
    bun install --frozen-lockfile
else
    echo "‚úì Dependencies up to date"
fi
'''

[tasks.setup]
description = "Full setup: install dependencies"
alias = "install"

# =============================================================================
# Build Tasks
# =============================================================================

[tasks.generate-bindings]
description = "Generate TypeScript type definitions from Rust DTOs using ts-rs"
script = '''
echo "üìù Generating TypeScript bindings from Rust DTOs..."
mkdir -p src/ffi/generated
cargo test export_bindings --package tasker-worker-ts -- --nocapture 2>/dev/null
echo "‚úÖ TypeScript bindings generated in src/ffi/generated/"
'''

[tasks.build-ffi]
description = "Build Rust FFI library (release)"
command = "cargo"
args = ["build", "-p", "tasker-worker-ts", "--release"]

[tasks.build-ffi-debug]
description = "Build Rust FFI library (debug, faster)"
command = "cargo"
args = ["build", "-p", "tasker-worker-ts"]

[tasks.build-ts]
description = "Build TypeScript package"
dependencies = ["install"]
command = "bun"
args = ["run", "build"]

# =============================================================================
# Quality Tasks
# =============================================================================

[tasks.lint]
description = "Run Biome checks (lint + format)"
dependencies = ["install"]
command = "bun"
args = ["run", "check"]

[tasks.lint-fix]
description = "Fix linting issues with Biome"
dependencies = ["install"]
script = '''
bun run biome check --write .
'''

[tasks.format-check]
description = "Check code formatting"
dependencies = ["install"]
script = '''
bun run biome format --check .
'''

[tasks.format-fix]
description = "Format code with Biome"
dependencies = ["install"]
script = '''
bun run biome format --write .
'''

[tasks.typecheck]
description = "Run TypeScript type checking"
dependencies = ["install"]
command = "bun"
args = ["run", "typecheck"]

# =============================================================================
# Test Tasks
# =============================================================================

[tasks.test]
description = "Run all tests"
dependencies = ["install"]
script = '''
. scripts/load-env.sh
bun test
'''

[tasks.test-watch]
description = "Run tests in watch mode"
dependencies = ["install"]
script = '''
. scripts/load-env.sh
bun test --watch
'''

[tasks.test-coverage]
description = "Run tests with coverage"
dependencies = ["install"]
script = '''
. scripts/load-env.sh
bun test --coverage
'''

[tasks.test-ci]
description = "Run tests with CI output format (text logs for artifact upload)"
dependencies = ["install"]
script_runner = "bash"
script = '''
set -o pipefail

# Ensure target directory exists
mkdir -p ../../target

# Run unit tests - output captured by CI, also saved to file for artifacts
bun test tests/unit/ 2>&1 | tee ../../target/typescript-unit-results.txt
'''

# =============================================================================
# Clean Tasks
# =============================================================================

[tasks.clean]
description = "Clean all build artifacts"
script = '''
echo "üßπ Cleaning build artifacts..."
rm -rf dist/
rm -rf node_modules/
cargo clean -p tasker-worker-ts
echo "‚úì Clean complete"
'''

[tasks.clean-ts]
description = "Clean TypeScript artifacts only"
script = '''
rm -rf dist/
'''

# =============================================================================
# Development Tasks
# =============================================================================

[tasks.watch]
description = "Watch mode for TypeScript development"
dependencies = ["install"]
command = "bun"
args = ["run", "build:watch"]

[tasks.dev]
description = "Development mode: build debug FFI and watch TS"
dependencies = ["build-ffi-debug", "watch"]

# =============================================================================
# FFI Integration Test Tasks
# =============================================================================
# These tests exercise the TaskerRuntime interface against the actual FFI library.
# Each runtime (Bun, Node.js, Deno) is tested independently.
#
# Prerequisites:
#   - cargo make build-ffi  (build the FFI library)
#   - Optional: DATABASE_URL for bootstrap tests
#
# Usage:
#   cargo make test-ffi-bun     # Run Bun FFI integration tests
#   cargo make test-ffi-node    # Run Node.js FFI integration tests
#   cargo make test-ffi-deno    # Run Deno FFI integration tests
#   cargo make test-ffi-all     # Run all FFI integration tests

[tasks.test-ffi-bun]
description = "Run FFI integration tests with Bun"
dependencies = ["build-ffi", "install"]
script = '''
source scripts/load-env.sh
echo "üß™ Running Bun FFI integration tests..."
bun test tests/integration/ffi/bun-runtime.test.ts
'''

[tasks.test-ffi-node]
description = "Run FFI integration tests with Node.js (requires: npm run setup:node)"
dependencies = ["build-ffi", "install"]
script = '''
source scripts/load-env.sh
echo "üß™ Running Node.js FFI integration tests..."
if ! command -v node &> /dev/null; then
    echo "‚ö†Ô∏è  Node.js not found, skipping Node.js FFI tests"
    exit 0
fi
# Check if koffi is installed (optional peer dependency)
if ! node -e "require.resolve('koffi')" 2>/dev/null; then
    echo "‚ö†Ô∏è  koffi not installed. Run 'npm run setup:node' to install Node.js FFI dependencies"
    echo "‚ö†Ô∏è  Skipping Node.js FFI tests"
    exit 0
fi
# Node requires tsx for TypeScript support
npx tsx --test tests/integration/ffi/node-runtime.test.ts
'''

[tasks.test-ffi-deno]
description = "Run FFI integration tests with Deno"
dependencies = ["build-ffi"]
script = '''
source scripts/load-env.sh
echo "üß™ Running Deno FFI integration tests..."
if ! command -v deno &> /dev/null; then
    echo "‚ö†Ô∏è  Deno not found, skipping Deno FFI tests"
    exit 0
fi
# Deno requires FFI and environment permissions
# Use --no-check to skip type checking (cross-runtime compatibility issues with base class resolution)
# Use --unstable-sloppy-imports for .js extension compatibility with Node/Bun ESM patterns
deno test --no-check --unstable-sloppy-imports --config deno.json --allow-ffi --allow-env --allow-read tests/integration/ffi/deno-runtime.test.ts
'''

[tasks.test-ffi-all]
description = "Run FFI integration tests for all available runtimes"
dependencies = ["build-ffi", "install"]
script = '''
source scripts/load-env.sh
FAILED=0

echo "üß™ Running Bun FFI integration tests..."
if bun test tests/integration/ffi/bun-runtime.test.ts; then
    echo "‚úÖ Bun FFI tests passed"
else
    echo "‚ùå Bun FFI tests failed"
    FAILED=1
fi

echo ""
echo "üß™ Running Node.js FFI integration tests..."
if ! command -v node &> /dev/null; then
    echo "‚ö†Ô∏è  Node.js not found, skipping"
elif ! node -e "require.resolve('koffi')" 2>/dev/null; then
    echo "‚ö†Ô∏è  koffi not installed (run 'npm run setup:node'), skipping"
elif npx tsx --test tests/integration/ffi/node-runtime.test.ts; then
    echo "‚úÖ Node.js FFI tests passed"
else
    echo "‚ùå Node.js FFI tests failed"
    FAILED=1
fi

echo ""
echo "üß™ Running Deno FFI integration tests..."
if ! command -v deno &> /dev/null; then
    echo "‚ö†Ô∏è  Deno not found, skipping"
elif deno test --no-check --unstable-sloppy-imports --config deno.json --allow-ffi --allow-env --allow-read tests/integration/ffi/deno-runtime.test.ts; then
    echo "‚úÖ Deno FFI tests passed"
else
    echo "‚ùå Deno FFI tests failed"
    FAILED=1
fi

echo ""
if [ $FAILED -eq 0 ]; then
    echo "‚úÖ All FFI integration tests completed successfully"
else
    echo "‚ùå Some FFI integration tests failed"
    exit 1
fi
'''

# =============================================================================
# Service Management Tasks
# =============================================================================
# Run the TypeScript worker as a local service for E2E testing.
# Uses the .env file for configuration.
#
# Prerequisites:
#   - cargo make build (builds FFI library and TypeScript)
#   - PostgreSQL running on localhost:5432
#   - Orchestration service running on localhost:8080
#
# Usage:
#   cargo make run      # Start TypeScript worker on port 8085
#   cargo make stop     # Stop the running worker
#   cargo make status   # Check worker status

[tasks.run]
description = "Run TypeScript worker service (port 8085)"
dependencies = ["build"]
script = '''
# Load environment from .env
source scripts/load-env.sh

# Override PORT for local execution
export PORT=8085

echo "üìò Starting TypeScript worker..."
echo "   Port: ${PORT}"
echo "   Config: ${TASKER_CONFIG_PATH}"
echo "   FFI Library: ${TASKER_FFI_LIBRARY_PATH}"

# Start the TypeScript server
PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-start.sh typescript-worker \
    bun run bin/server.ts
'''

[tasks.run-foreground]
description = "Run TypeScript worker in foreground (for debugging)"
dependencies = ["build"]
script = '''
# Load environment from .env
source scripts/load-env.sh

# Override PORT for local execution
export PORT=8085

echo "üìò Starting TypeScript worker (foreground)..."
echo "   Port: ${PORT}"
echo "   Config: ${TASKER_CONFIG_PATH}"

# Run directly in foreground
bun run bin/server.ts
'''

[tasks.stop]
description = "Stop running TypeScript worker service"
script = '''
PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-stop.sh typescript-worker
'''

[tasks.status]
description = "Check TypeScript worker service status"
script = '''
PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-status.sh typescript-worker
'''

[tasks.logs]
description = "Tail TypeScript worker logs"
script = '''
LOG_FILE="../../.logs/typescript-worker.log"
if [ -f "$LOG_FILE" ]; then
    tail -f "$LOG_FILE"
else
    echo "No log file found at $LOG_FILE"
    echo "Start the worker first with: cargo make run"
fi
'''
