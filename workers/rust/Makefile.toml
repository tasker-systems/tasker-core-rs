# =============================================================================
# Rust Worker - cargo-make Task Definitions
# =============================================================================
#
# Rust-native worker implementation. Uses the standard cargo-make base tasks.
#
# Quick Start:
#   cargo make check    # Run all quality checks
#   cargo make test     # Run tests
#   cargo make build    # Build the worker
#   cargo make run      # Run the worker service
#
# =============================================================================

extend = "../../cargo-make/base-tasks.toml"

[config]
default_to_workspace = false
skip_core_tasks = true

[env]
CRATE_NAME = "tasker-worker-rust"

# =============================================================================
# Main Tasks
# =============================================================================

[tasks.default]
alias = "check"

[tasks.check]
description = "Run Rust worker quality checks"
dependencies = ["format-check", "lint", "test"]

[tasks.build]
extend = "base-rust-build"
description = "Build the Rust worker"
args = ["build", "-p", "${CRATE_NAME}", "--all-features"]

[tasks.build-release]
extend = "base-rust-build-release"
description = "Build the Rust worker (release)"
args = ["build", "-p", "${CRATE_NAME}", "--all-features", "--release"]

[tasks.format-check]
extend = "base-rust-format"

[tasks.format-fix]
extend = "base-rust-format-fix"

[tasks.lint]
extend = "base-rust-lint"

[tasks.lint-fix]
extend = "base-rust-lint-fix"

[tasks.test]
extend = "base-rust-test"
description = "Run Rust worker tests"
args = ["nextest", "run", "-p", "${CRATE_NAME}", "--all-features"]

[tasks.fix]
description = "Fix all fixable issues"
dependencies = ["format-fix", "lint-fix"]

[tasks.clean]
description = "Clean build artifacts"
command = "cargo"
args = ["clean", "-p", "${CRATE_NAME}"]

[tasks.coverage]
description = "Run coverage and generate normalized JSON"
script = '''
#!/bin/bash
set -euo pipefail

# Source environment like test tasks do (from project root)
set -a
source ../../.env 2>/dev/null || true
source .env 2>/dev/null || true
set +a

echo "Running Rust worker coverage..."
mkdir -p ../../coverage-reports/rust

# Use nextest for test isolation (auth tests set env vars that leak in cargo test)
cargo llvm-cov nextest --package tasker-worker-rust --all-features \
  --json --output-path ../../coverage-reports/rust/tasker-worker-rust-raw.json

# Normalize to standard schema
uv run --project ../../cargo-make/scripts/coverage python3 \
  ../../cargo-make/scripts/coverage/normalize-rust.py \
  ../../coverage-reports/rust/tasker-worker-rust-raw.json \
  ../../coverage-reports/rust/tasker-worker-rust-coverage.json \
  --crate tasker-worker-rust

echo "Coverage complete"
echo "  Normalized: ../../coverage-reports/rust/tasker-worker-rust-coverage.json"
'''

[tasks.test-coverage]
description = "Run tests with coverage report (HTML)"
script = '''
#!/bin/bash
set -euo pipefail

# Source environment like test tasks do (from project root)
set -a
source ../../.env 2>/dev/null || true
source .env 2>/dev/null || true
set +a

cargo llvm-cov nextest --package tasker-worker-rust --all-features --html
echo "HTML coverage report: target/llvm-cov/html/index.html"
'''

# =============================================================================
# Service Tasks
# =============================================================================

[tasks.run]
description = "Run Rust worker service (port 8081)"
script = '''
# Source local .env for worker-specific configuration
set -a
source .env
set +a

# Override PORT for local execution
export PORT=8081

echo "ðŸ¦€ Starting Rust worker..."
echo "   Port: ${PORT}"
echo "   Config: ${TASKER_CONFIG_PATH}"
echo "   Templates: ${TASKER_TEMPLATE_PATH}"

PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-start.sh rust-worker \
    cargo run -p tasker-worker-rust
'''

[tasks.run-foreground]
description = "Run Rust worker in foreground (for debugging)"
script = '''
# Source local .env for worker-specific configuration
set -a
source .env
set +a

# Override PORT for local execution
export PORT=8081

echo "ðŸ¦€ Starting Rust worker (foreground)..."
echo "   Port: ${PORT}"
echo "   Config: ${TASKER_CONFIG_PATH}"
echo "   Templates: ${TASKER_TEMPLATE_PATH}"

cargo run -p tasker-worker-rust
'''

[tasks.run-release]
description = "Run Rust worker service (release build)"
script = '''
# Source local .env for worker-specific configuration
set -a
source .env
set +a

# Override PORT for local execution
export PORT=8081

echo "ðŸ¦€ Starting Rust worker (release)..."
echo "   Port: ${PORT}"
echo "   Config: ${TASKER_CONFIG_PATH}"
echo "   Templates: ${TASKER_TEMPLATE_PATH}"

PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-start.sh rust-worker \
    cargo run -p tasker-worker-rust --release
'''

[tasks.stop]
description = "Stop Rust worker service"
script = '''
PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-stop.sh rust-worker
'''

[tasks.status]
description = "Check Rust worker service status"
script = '''
PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-status.sh rust-worker
'''

[tasks.logs]
description = "Tail Rust worker logs"
script = '''
LOG_FILE="../../.logs/rust-worker.log"
if [ -f "$LOG_FILE" ]; then
    tail -f "$LOG_FILE"
else
    echo "No log file found at $LOG_FILE"
    echo "Start the worker first with: cargo make run"
fi
'''

# =============================================================================
# Setup (no-op for Rust)
# =============================================================================

[tasks.setup]
description = "Setup (no-op for Rust worker)"
script = '''echo "âœ“ Rust worker has no setup requirements"'''
