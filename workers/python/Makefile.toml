# =============================================================================
# Tasker Python Worker - cargo-make Task Definitions
# =============================================================================
#
# This file defines build, test, and quality tasks for the Python worker.
# Uses uv for package management, maturin for building, and ruff/mypy for quality.
#
# Usage:
#   cargo make check       # Run all checks (format, lint, types, test)
#   cargo make build       # Build Rust extension with maturin
#   cargo make test        # Run pytest
#   cargo make fix         # Auto-fix linting issues
#
# =============================================================================

[config]
default_to_workspace = false
skip_core_tasks = true

# =============================================================================
# Composite Tasks
# =============================================================================

[tasks.default]
description = "Default: run all checks"
alias = "check"

[tasks.check]
description = "Run all quality checks (format, lint, types, test)"
dependencies = ["format-check", "lint", "typecheck", "test"]

[tasks.build]
description = "Build Rust extension with maturin"
dependencies = ["setup", "build-extension"]

[tasks.fix]
description = "Auto-fix all fixable issues"
dependencies = ["format-fix", "lint-fix"]

# =============================================================================
# Setup Tasks
# =============================================================================

[tasks.setup]
description = "Setup Python virtual environment and dependencies"
script = '''
if [ ! -d ".venv" ]; then
    echo "üì¶ Creating virtual environment..."
    uv venv
fi
echo "üì¶ Syncing dependencies..."
uv sync --group dev
'''

[tasks.install]
description = "Alias for setup"
alias = "setup"

# =============================================================================
# Build Tasks
# =============================================================================

[tasks.build-extension]
description = "Build Rust extension with maturin (development mode)"
dependencies = ["setup"]
script = '''
echo "üî® Building Rust extension..."
uv run maturin develop
echo "‚úì Extension built"
'''

[tasks.build-release]
description = "Build Rust extension for release"
dependencies = ["setup"]
script = '''
echo "üî® Building Rust extension (release)..."
uv run maturin build --release
'''

# =============================================================================
# Quality Tasks
# =============================================================================

[tasks.format-check]
description = "Check code formatting with ruff"
dependencies = ["setup"]
script = '''
uv run ruff format --check .
'''

[tasks.format-fix]
description = "Format code with ruff"
dependencies = ["setup"]
script = '''
uv run ruff format .
'''

[tasks.lint]
description = "Run ruff linter"
dependencies = ["setup"]
script = '''
uv run ruff check .
'''

[tasks.lint-fix]
description = "Fix linting issues with ruff"
dependencies = ["setup"]
script = '''
uv run ruff check --fix .
'''

[tasks.typecheck]
description = "Run mypy type checking"
dependencies = ["setup"]
script = '''
uv run mypy python/
'''

# =============================================================================
# Test Tasks
# =============================================================================

[tasks.test]
description = "Run all tests with pytest"
dependencies = ["setup", "build-extension"]
script = '''
uv run pytest
'''

[tasks.test-verbose]
description = "Run tests with verbose output"
dependencies = ["setup", "build-extension"]
script = '''
uv run pytest -v
'''

[tasks.test-coverage]
description = "Run tests with coverage report"
dependencies = ["setup", "build-extension"]
script = '''
uv run pytest --cov=python/tasker_core --cov-report=term-missing
'''

[tasks.coverage]
description = "Run coverage and generate normalized JSON (for root delegation)"
dependencies = ["setup", "build-extension"]
script = '''
#!/bin/bash
set -euo pipefail

echo "Running Python coverage..."
mkdir -p ../../coverage-reports/python

# Run pytest with coverage and JSON output
# Override fail_under=0 so data collection always succeeds;
# threshold enforcement happens via cargo make coverage-check
uv run pytest --cov=python/tasker_core --cov-fail-under=0 \
  --cov-report=json:../../coverage-reports/python/raw-coverage.json

# Normalize to standard schema
uv run --project ../../cargo-make/scripts/coverage python3 \
  ../../cargo-make/scripts/coverage/normalize-python.py \
  ../../coverage-reports/python/raw-coverage.json \
  ../../coverage-reports/python/tasker-core-py-coverage.json

echo "Coverage complete"
echo "  Normalized: ../../coverage-reports/python/tasker-core-py-coverage.json"
'''

[tasks.coverage-json]
description = "Generate coverage JSON report (for CI/integration)"
dependencies = ["setup", "build-extension"]
script = '''
#!/bin/bash
set -euo pipefail
mkdir -p ../../coverage-reports/python
uv run pytest --cov=python/tasker_core --cov-report=json:../../coverage-reports/python/raw-coverage.json
'''

[tasks.test-ffi]
description = "Run FFI integration tests (for root delegation)"
dependencies = ["setup", "build-extension"]
script = '''
# Python tests implicitly test the FFI layer through the maturin-built extension
uv run pytest -v
'''

[tasks.test-ci]
description = "Run tests with CI output format (JUnit XML)"
dependencies = ["setup", "build-extension"]
script = '''
# Ensure target directory exists
mkdir -p ../../target

# Run tests with verbose output and JUnit XML
uv run pytest tests/ \
  -v \
  --tb=short \
  --junitxml=../../target/python-framework-results.xml
'''

# =============================================================================
# Rust Extension Tasks (for the FFI layer)
# =============================================================================

[tasks.rust-check]
description = "Check Rust code compiles"
command = "cargo"
args = ["check"]

[tasks.rust-clippy]
description = "Run clippy on Rust code"
command = "cargo"
args = ["clippy", "--all-targets", "--", "-D", "warnings"]

[tasks.rust-fmt]
description = "Check Rust formatting"
command = "cargo"
args = ["fmt", "--all", "--", "--check"]

[tasks.rust-fmt-fix]
description = "Format Rust code"
command = "cargo"
args = ["fmt", "--all"]

# =============================================================================
# Clean Tasks
# =============================================================================

[tasks.clean]
description = "Clean all build artifacts"
script = '''
echo "üßπ Cleaning build artifacts..."
rm -rf .venv/
rm -rf target/
rm -rf .ruff_cache/
rm -rf .mypy_cache/
rm -rf .pytest_cache/
rm -rf .coverage
rm -rf htmlcov/
rm -rf *.egg-info/
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
echo "‚úì Clean complete"
'''

[tasks.clean-build]
description = "Clean build artifacts only (keep venv)"
script = '''
rm -rf target/
rm -rf *.egg-info/
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
'''

# =============================================================================
# Service Management Tasks
# =============================================================================
# Run the Python worker as a local service for E2E testing.
# Uses the .env file for configuration.
#
# Prerequisites:
#   - cargo make build-extension (builds the Rust FFI layer)
#   - PostgreSQL running on localhost:5432
#   - Orchestration service running on localhost:8080
#
# Usage:
#   cargo make run      # Start Python worker on port 8083
#   cargo make stop     # Stop the running worker
#   cargo make status   # Check worker status

[tasks.run]
description = "Run Python worker service (port 8083)"
dependencies = ["setup", "build-extension"]
script = '''
# Source environment from .env
set -a
source .env
set +a

# Override PORT for local execution
export PORT=8083

echo "üêç Starting Python worker..."
echo "   Port: ${PORT}"
echo "   Config: ${TASKER_CONFIG_PATH}"
echo "   Templates: ${TASKER_TEMPLATE_PATH}"
echo "   Handlers: ${PYTHON_HANDLER_PATH}"

# Start the Python server (use uv run to get dependencies)
PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-start.sh python-worker \
    uv run python bin/server.py
'''

[tasks.run-foreground]
description = "Run Python worker in foreground (for debugging)"
dependencies = ["setup", "build-extension"]
script = '''
# Source environment from .env
set -a
source .env
set +a

# Override PORT for local execution
export PORT=8083

echo "üêç Starting Python worker (foreground)..."
echo "   Port: ${PORT}"
echo "   Config: ${TASKER_CONFIG_PATH}"

# Run directly in foreground (use uv run to get dependencies)
uv run python bin/server.py
'''

[tasks.stop]
description = "Stop running Python worker service"
script = '''
PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-stop.sh python-worker
'''

[tasks.status]
description = "Check Python worker service status"
script = '''
PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-status.sh python-worker
'''

[tasks.logs]
description = "Tail Python worker logs"
script = '''
LOG_FILE="../../.logs/python-worker.log"
if [ -f "$LOG_FILE" ]; then
    tail -f "$LOG_FILE"
else
    echo "No log file found at $LOG_FILE"
    echo "Start the worker first with: cargo make run"
fi
'''
