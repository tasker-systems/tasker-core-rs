# =============================================================================
# Tasker Ruby Worker - cargo-make Task Definitions
# =============================================================================
#
# This file defines build, test, and quality tasks for the Ruby worker.
# Uses Bundler for package management and RuboCop for linting.
# The Rust FFI extension is at ext/tasker_core.
#
# Usage:
#   cargo make check       # Run all checks (lint, compile, test)
#   cargo make build       # Compile Rust extension
#   cargo make test        # Run rspec
#   cargo make fix         # Auto-fix linting issues
#
# =============================================================================

[config]
default_to_workspace = false
skip_core_tasks = true

# =============================================================================
# Composite Tasks
# =============================================================================

[tasks.default]
description = "Default: run all checks"
alias = "check"

[tasks.check]
description = "Run all quality checks (lint, rust-check, build, test)"
dependencies = ["lint", "rust-check", "build", "test"]

[tasks.build]
description = "Compile Rust extension"
dependencies = ["setup", "compile"]

[tasks.fix]
description = "Auto-fix all fixable issues"
dependencies = ["lint-fix", "rust-fmt-fix"]

# =============================================================================
# Setup Tasks
# =============================================================================

[tasks.setup]
description = "Install Ruby dependencies with Bundler"
script = '''
if ! bundle check &>/dev/null; then
    echo "ðŸ“¦ Installing Ruby dependencies..."
    bundle install
else
    echo "âœ“ Dependencies up to date"
fi
'''

[tasks.install]
description = "Alias for setup"
alias = "setup"

# =============================================================================
# Build Tasks
# =============================================================================

[tasks.compile]
description = "Compile Rust extension with rake"
dependencies = ["setup"]
script = '''
echo "ðŸ”¨ Compiling Rust extension..."
bundle exec rake compile
echo "âœ“ Extension compiled"
'''

[tasks.compile-clean]
description = "Clean and recompile extension"
dependencies = ["setup"]
script = '''
bundle exec rake clean compile
'''

# =============================================================================
# Quality Tasks
# =============================================================================

[tasks.lint]
description = "Run RuboCop linter"
dependencies = ["setup"]
script = '''
bundle exec rubocop
'''

[tasks.lint-fix]
description = "Auto-fix RuboCop issues"
dependencies = ["setup"]
script = '''
bundle exec rubocop --autocorrect
'''

[tasks.lint-fix-all]
description = "Aggressively auto-fix RuboCop issues"
dependencies = ["setup"]
script = '''
bundle exec rubocop --auto-correct-all
'''

# =============================================================================
# Rust Extension Quality Tasks
# =============================================================================

[tasks.rust-check]
description = "Check Rust extension compiles"
cwd = "ext/tasker_core"
command = "cargo"
args = ["check"]

[tasks.rust-clippy]
description = "Run clippy on Rust extension"
cwd = "ext/tasker_core"
command = "cargo"
args = ["clippy", "--all-targets", "--", "-D", "warnings"]

[tasks.rust-fmt]
description = "Check Rust extension formatting"
cwd = "ext/tasker_core"
command = "cargo"
args = ["fmt", "--all", "--", "--check"]

[tasks.rust-fmt-fix]
description = "Format Rust extension code"
cwd = "ext/tasker_core"
command = "cargo"
args = ["fmt", "--all"]

[tasks.rust-all]
description = "Run all Rust extension checks"
dependencies = ["rust-fmt", "rust-clippy"]

# =============================================================================
# Test Tasks
# =============================================================================

[tasks.test]
description = "Run all tests with rspec"
dependencies = ["setup", "compile"]
script = '''
bundle exec rspec
'''

[tasks.test-verbose]
description = "Run tests with verbose output"
dependencies = ["setup", "compile"]
script = '''
bundle exec rspec --format documentation
'''

[tasks.test-failed]
description = "Re-run only failed tests"
dependencies = ["setup", "compile"]
script = '''
bundle exec rspec --only-failures
'''

[tasks.test-ffi]
description = "Run FFI integration tests (for root delegation)"
dependencies = ["setup", "compile"]
script = '''
bundle exec rspec spec/ffi/ --format documentation
'''

[tasks.test-ci]
description = "Run tests with CI output format (JUnit XML)"
dependencies = ["setup", "compile"]
script = '''
# Ensure target directory exists
mkdir -p ../../target

# Run tests with documentation and JUnit XML output
bundle exec rspec spec/ \
  --format documentation \
  --format RspecJunitFormatter \
  --out ../../target/ruby-framework-results.xml
'''

# =============================================================================
# Documentation Tasks
# =============================================================================

[tasks.docs]
description = "Generate YARD documentation"
dependencies = ["setup"]
script = '''
bundle exec yard doc
'''

# =============================================================================
# Clean Tasks
# =============================================================================

[tasks.clean]
description = "Clean all build artifacts"
script = '''
echo "ðŸ§¹ Cleaning build artifacts..."
bundle exec rake clean 2>/dev/null || true
rm -rf tmp/
rm -rf lib/*.bundle lib/*.so lib/*.dylib 2>/dev/null || true
(cd ext/tasker_core && cargo clean) 2>/dev/null || true
echo "âœ“ Clean complete"
'''

[tasks.clean-full]
description = "Clean everything including vendor"
script = '''
echo "ðŸ§¹ Full clean..."
bundle exec rake clean 2>/dev/null || true
rm -rf tmp/
rm -rf vendor/
rm -rf .bundle/
rm -rf lib/*.bundle lib/*.so lib/*.dylib 2>/dev/null || true
(cd ext/tasker_core && cargo clean) 2>/dev/null || true
echo "âœ“ Full clean complete"
'''

# =============================================================================
# Development Tasks
# =============================================================================

[tasks.console]
description = "Start an IRB console with the gem loaded"
dependencies = ["setup", "compile"]
script = '''
bundle exec bin/console
'''

# =============================================================================
# Service Management Tasks
# =============================================================================
# Run the Ruby worker as a local service for E2E testing.
# Uses the .env.test file for configuration.
#
# Prerequisites:
#   - cargo make build (compiles Rust extension)
#   - PostgreSQL running on localhost:5432
#   - Orchestration service running on localhost:8080
#
# Usage:
#   cargo make run      # Start Ruby worker on port 8082
#   cargo make stop     # Stop the running worker
#   cargo make status   # Check worker status

[tasks.run]
description = "Run Ruby worker service (port 8082)"
dependencies = ["setup", "compile"]
script = '''
# Source environment from .env.test
set -a
source .env.test
set +a

# Override PORT for local execution
export PORT=8082

echo "ðŸ’Ž Starting Ruby worker..."
echo "   Port: ${PORT}"
echo "   Config: ${TASKER_CONFIG_PATH}"
echo "   Handlers: ${RUBY_HANDLER_PATH}"

# Start the Ruby server
PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-start.sh ruby-worker \
    bundle exec ruby bin/server.rb
'''

[tasks.run-foreground]
description = "Run Ruby worker in foreground (for debugging)"
dependencies = ["setup", "compile"]
script = '''
# Source environment from .env.test
set -a
source .env.test
set +a

# Override PORT for local execution
export PORT=8082

echo "ðŸ’Ž Starting Ruby worker (foreground)..."
echo "   Port: ${PORT}"
echo "   Config: ${TASKER_CONFIG_PATH}"

# Run directly in foreground
bundle exec ruby bin/server.rb
'''

[tasks.stop]
description = "Stop running Ruby worker service"
script = '''
PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-stop.sh ruby-worker
'''

[tasks.status]
description = "Check Ruby worker service status"
script = '''
PROJECT_ROOT="$(cd ../.. && pwd)" \
../../cargo-make/scripts/service-status.sh ruby-worker
'''

[tasks.logs]
description = "Tail Ruby worker logs"
script = '''
LOG_FILE="../../.logs/ruby-worker.log"
if [ -f "$LOG_FILE" ]; then
    tail -f "$LOG_FILE"
else
    echo "No log file found at $LOG_FILE"
    echo "Start the worker first with: cargo make run"
fi
'''
