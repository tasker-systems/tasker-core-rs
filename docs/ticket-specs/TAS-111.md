# TAS-111: Standardize and Optimize cargo-make Configuration

## Summary

Standardize cargo-make task definitions across the tasker-core workspace using the `extends` pattern to improve consistency, reduce duplication, and enable better task delegation from root to crate-specific Makefile.toml files.

## Problem Statement

Current cargo-make configuration has several issues:

1. **Missing Makefile.toml files** for Rust crates (tasker-pgmq, tasker-client, tasker-shared, tasker-orchestration, tasker-worker) and workers/rust
2. **No centralized base tasks** - missing opportunity for inheritance via `extends`
3. **Inline shell scripts** - difficult to debug and test compared to dedicated .sh files
4. **Inconsistent setup naming** - TypeScript uses `install` while Python/Ruby use `setup`
5. **Missing FFI test delegation** - Root only delegates TypeScript FFI tests, not Ruby/Python
6. **No cargo-make/ directory** for shared templates and scripts

## Current State Analysis

### Existing Makefile.toml Files

| Location | Lines | Status | Notes |
|----------|-------|--------|-------|
| `Makefile.toml` (root) | 455 | Well-structured | Good delegation pattern, needs extends |
| `workers/python/Makefile.toml` | 209 | Complete | Uses uv + maturin |
| `workers/ruby/Makefile.toml` | 225 | Complete | Uses bundler + rake |
| `workers/typescript/Makefile.toml` | 299 | Complete | Multi-runtime FFI (Bun/Node/Deno) |
| `workers/rust/Makefile.toml` | - | **Missing** | Needs creation |
| Crate Makefile.toml files | - | **Missing** | All 5 crates need files |

### Existing Infrastructure (To Reuse)

- `.config/nextest.toml` - 3 profiles (default, ci, local) - **Complete**
- `.github/scripts/start-native-services.sh` - Service orchestration (209 lines)
- `.github/scripts/stop-native-services.sh` - Service cleanup (28 lines)
- `.github/scripts/aggregate-performance-metrics.sh` - CI metrics (71 lines)
- `.github/actions/setup-env/` - Environment configuration
- `.github/actions/install-tools/` - Cargo tool installation
- `.github/actions/free-disk-space/` - CI disk cleanup

### Port Assignments (Current)

| Service | Port | Notes |
|---------|------|-------|
| Orchestration | 8080 | tasker-orchestration |
| Rust Worker | 8081 | workers/rust |
| Ruby Worker | 8082 | workers/ruby |
| Python Worker | 8083 | workers/python |
| TypeScript Worker | **8085** | workers/typescript (8084 avoided - Mono XSP4 conflict) |

## Solution Design

### Action Nomenclature Standardization

Define clear, unambiguous actions consistent across all crates:

| Action | Description | Operations |
|--------|-------------|------------|
| `build` | Compile/build artifacts | Standard build |
| `build-release` | Production build | Optimized/release build |
| `clean` | Remove build artifacts | Clean target dirs, caches |
| `format-check` | Check code formatting | Verify formatting standards |
| `format-fix` | Auto-fix formatting | Apply formatting changes |
| `lint` | Run linters | Static analysis, clippy, etc. |
| `lint-fix` | Auto-fix linting issues | Apply safe lint fixes |
| `test` | Run tests | Framework-appropriate tests |
| `test-ffi` | FFI integration tests | Cross-language FFI validation |
| `check` | All quality checks | format-check + lint + test |
| `fix` | Fix all fixable issues | format-fix + lint-fix |
| `run` | Run service | Source .env, build, run foreground |
| `setup` | Install dependencies | Language-specific deps |

### Directory Structure

```
tasker-core/
â”œâ”€â”€ Makefile.toml                    # Root orchestrator (extends base files)
â”œâ”€â”€ .config/
â”‚   â””â”€â”€ nextest.toml                 # Nextest profiles (already complete)
â”œâ”€â”€ cargo-make/
â”‚   â”œâ”€â”€ base-tasks.toml              # Shared task templates
â”‚   â”œâ”€â”€ workspace-config.toml        # Workspace-level config
â”‚   â”œâ”€â”€ cross-cutting.toml           # Cross-language concerns
â”‚   â”œâ”€â”€ test-tasks.toml              # Test-specific tasks
â”‚   â”œâ”€â”€ ci-integration.toml          # CI workflow alignment
â”‚   â””â”€â”€ scripts/                     # Extracted shell scripts
â”‚       â”œâ”€â”€ check-db.sh              # Database connectivity check
â”‚       â”œâ”€â”€ run-migrations.sh        # SQLx migrations
â”‚       â”œâ”€â”€ reset-db.sh              # Database reset
â”‚       â”œâ”€â”€ sqlx-prepare.sh          # Update query cache
â”‚       â”œâ”€â”€ setup-workers.sh         # Worker setup orchestration
â”‚       â”œâ”€â”€ clean-workers.sh         # Worker cleanup
â”‚       â”œâ”€â”€ check-services.sh        # Service health checks
â”‚       â””â”€â”€ setup-env.sh             # Environment setup (local)
â”œâ”€â”€ tasker-pgmq/
â”‚   â””â”€â”€ Makefile.toml                # Library crate tasks
â”œâ”€â”€ tasker-client/
â”‚   â””â”€â”€ Makefile.toml                # Library crate tasks
â”œâ”€â”€ tasker-orchestration/
â”‚   â””â”€â”€ Makefile.toml                # Service crate tasks (includes run)
â”œâ”€â”€ tasker-shared/
â”‚   â””â”€â”€ Makefile.toml                # Library crate tasks
â”œâ”€â”€ tasker-worker/
â”‚   â””â”€â”€ Makefile.toml                # Service crate tasks (includes run)
â”œâ”€â”€ workers/
â”‚   â”œâ”€â”€ rust/
â”‚   â”‚   â””â”€â”€ Makefile.toml            # Rust worker tasks (includes run)
â”‚   â”œâ”€â”€ ruby/
â”‚   â”‚   â””â”€â”€ Makefile.toml            # Extends base (update for consistency)
â”‚   â”œâ”€â”€ python/
â”‚   â”‚   â””â”€â”€ Makefile.toml            # Extends base (update for consistency)
â”‚   â””â”€â”€ typescript/
â”‚       â””â”€â”€ Makefile.toml            # Extends base, multi-runtime FFI
â””â”€â”€ tests/                           # E2E tests location
```

### Shell Scripts (cargo-make/scripts/)

All shell scripts follow consistent patterns:
- `set -euo pipefail` for strict error handling
- Emoji prefixes for visual feedback (ðŸ“¦, ðŸ”, âœ“, âœ—)
- Exit codes for error propagation
- Environment variable documentation

#### `cargo-make/scripts/check-db.sh`
```bash
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ” Checking database connectivity..."
if pg_isready -h localhost -p "${PGPORT:-5432}" -U "${PGUSER:-tasker}"; then
    echo "âœ“ Database is ready"
else
    echo "âœ— Database is not available"
    echo "  Start it with: docker-compose up -d postgres"
    exit 1
fi
```

#### `cargo-make/scripts/run-migrations.sh`
```bash
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ“¦ Running migrations..."
sqlx migrate run
echo "âœ“ Migrations complete"
```

#### `cargo-make/scripts/reset-db.sh`
```bash
#!/usr/bin/env bash
set -euo pipefail

echo "âš ï¸  Resetting database..."
sqlx database drop -y 2>/dev/null || true
sqlx database create
sqlx migrate run
echo "âœ“ Database reset complete"
```

#### `cargo-make/scripts/sqlx-prepare.sh`
```bash
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ“¦ Preparing SQLX cache..."
cargo sqlx prepare --workspace -- --all-targets --all-features
echo "âœ“ SQLX cache prepared"
echo ""
echo "Don't forget to commit the .sqlx directories!"
```

#### `cargo-make/scripts/setup-workers.sh`
```bash
#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

echo "ðŸ“¦ Setting up workers..."

echo "  â†’ Python worker..."
(cd "$WORKSPACE_ROOT/workers/python" && cargo make setup)

echo "  â†’ Ruby worker..."
(cd "$WORKSPACE_ROOT/workers/ruby" && cargo make setup)

echo "  â†’ TypeScript worker..."
(cd "$WORKSPACE_ROOT/workers/typescript" && cargo make setup)

echo "âœ“ All workers setup"
```

#### `cargo-make/scripts/clean-workers.sh`
```bash
#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

echo "ðŸ§¹ Cleaning workers..."

(cd "$WORKSPACE_ROOT/workers/python" && cargo make clean) 2>/dev/null || true
(cd "$WORKSPACE_ROOT/workers/ruby" && cargo make clean) 2>/dev/null || true
(cd "$WORKSPACE_ROOT/workers/typescript" && cargo make clean) 2>/dev/null || true

echo "âœ“ Workers cleaned"
```

#### `cargo-make/scripts/check-services.sh`
```bash
#!/usr/bin/env bash
set -euo pipefail

# Check required services for testing
# Ports align with docker-compose and start-native-services.sh

POSTGRES_PORT="${POSTGRES_PORT:-5432}"
ORCHESTRATION_PORT="${ORCHESTRATION_PORT:-8080}"
RUST_WORKER_PORT="${RUST_WORKER_PORT:-8081}"
RUBY_WORKER_PORT="${RUBY_WORKER_PORT:-8082}"
PYTHON_WORKER_PORT="${PYTHON_WORKER_PORT:-8083}"
TYPESCRIPT_WORKER_PORT="${TYPESCRIPT_WORKER_PORT:-8085}"

echo "ðŸ” Checking services..."

# PostgreSQL (required)
if pg_isready -h localhost -p "$POSTGRES_PORT" > /dev/null 2>&1; then
    echo "âœ“ PostgreSQL is running on port $POSTGRES_PORT"
else
    echo "âœ— PostgreSQL is not running on port $POSTGRES_PORT"
    echo "  Start with: docker-compose up -d postgres"
    exit 1
fi

# Optional service checks
check_service() {
    local name="$1"
    local port="$2"
    if curl -sf "http://localhost:$port/health" > /dev/null 2>&1; then
        echo "âœ“ $name is running on port $port"
    else
        echo "âš  $name is not running on port $port (optional)"
    fi
}

if [ "${CHECK_ALL_SERVICES:-false}" = "true" ]; then
    check_service "Orchestration" "$ORCHESTRATION_PORT"
    check_service "Rust Worker" "$RUST_WORKER_PORT"
    check_service "Ruby Worker" "$RUBY_WORKER_PORT"
    check_service "Python Worker" "$PYTHON_WORKER_PORT"
    check_service "TypeScript Worker" "$TYPESCRIPT_WORKER_PORT"
fi

echo "âœ“ Service check complete"
```

#### `cargo-make/scripts/setup-env.sh`
```bash
#!/usr/bin/env bash
set -euo pipefail

# Setup environment variables for local development
# Mirrors .github/actions/setup-env but for local use

echo "ðŸ“¦ Setting up environment..."

# Load .env if exists
if [ -f ".env" ]; then
    echo "  Loading .env file..."
    set -a
    source .env
    set +a
fi

# Set defaults if not already set
export DATABASE_URL="${DATABASE_URL:-postgresql://tasker:tasker@localhost:5432/tasker_rust_test}"
export TASKER_ENV="${TASKER_ENV:-test}"
export RUST_BACKTRACE="${RUST_BACKTRACE:-1}"
export CARGO_TERM_COLOR="${CARGO_TERM_COLOR:-always}"
export RUST_LOG="${RUST_LOG:-warn}"

echo "  DATABASE_URL=${DATABASE_URL}"
echo "  TASKER_ENV=${TASKER_ENV}"
echo "âœ“ Environment configured"
```

### Base Task Templates

#### `cargo-make/base-tasks.toml`
```toml
# =============================================================================
# Base Task Templates - Shared across all crates
# =============================================================================
#
# Usage: extend = { path = "../cargo-make/base-tasks.toml" }
# Or for workers: extend = { path = "../../cargo-make/base-tasks.toml" }
#
# =============================================================================

# -----------------------------------------------------------------------------
# Abstract Base Tasks (override in crate-specific files)
# -----------------------------------------------------------------------------

[tasks.base-build]
description = "Base build template"
category = "Build"

[tasks.base-clean]
description = "Base clean template"
category = "Maintenance"

[tasks.base-format]
description = "Base format check template"
category = "Quality"

[tasks.base-format-fix]
description = "Base format fix template"
category = "Quality"

[tasks.base-lint]
description = "Base lint template"
category = "Quality"

[tasks.base-lint-fix]
description = "Base lint fix template"
category = "Quality"

[tasks.base-test]
description = "Base test template"
category = "Test"

[tasks.base-run]
description = "Base run template (for services)"
category = "Development"

# -----------------------------------------------------------------------------
# Rust-Specific Base Tasks
# -----------------------------------------------------------------------------

[tasks.base-rust-format]
extend = "base-format"
description = "Check Rust formatting"
command = "cargo"
args = ["fmt", "--all", "--", "--check"]

[tasks.base-rust-format-fix]
extend = "base-format-fix"
description = "Fix Rust formatting"
command = "cargo"
args = ["fmt", "--all"]

[tasks.base-rust-lint]
extend = "base-lint"
description = "Run Clippy lints"
command = "cargo"
args = ["clippy", "--all-targets", "--all-features", "--", "-D", "warnings"]

[tasks.base-rust-lint-fix]
extend = "base-lint-fix"
description = "Fix Clippy issues"
command = "cargo"
args = ["clippy", "--all-targets", "--all-features", "--fix", "--allow-dirty", "--allow-staged"]

[tasks.base-rust-test]
extend = "base-test"
description = "Run tests with nextest"
command = "cargo"
args = ["nextest", "run", "--all-features"]

[tasks.base-rust-test-ci]
extend = "base-rust-test"
description = "Run tests with CI profile"
args = ["nextest", "run", "--all-features", "--profile", "ci"]

[tasks.base-rust-test-docs]
description = "Run documentation tests"
category = "Test"
command = "cargo"
args = ["test", "--doc", "--all-features"]

[tasks.base-rust-build]
extend = "base-build"
description = "Build Rust crate"
command = "cargo"
args = ["build", "--all-features"]

[tasks.base-rust-build-release]
description = "Build Rust crate (release)"
category = "Build"
command = "cargo"
args = ["build", "--all-features", "--release"]

# -----------------------------------------------------------------------------
# Worker Delegation Base
# -----------------------------------------------------------------------------

[tasks.base-delegate-to-worker]
description = "Base task for worker delegation"
command = "cargo"
args = ["make"]
```

#### `cargo-make/workspace-config.toml`
```toml
# =============================================================================
# Workspace Configuration - Global settings and environment
# =============================================================================

[config]
default_to_workspace = false

[env]
CARGO_MAKE_EXTEND_WORKSPACE_MAKEFILE = true
WORKSPACE_ROOT = "${CARGO_MAKE_WORKSPACE_WORKING_DIRECTORY}"
SCRIPTS_DIR = "${WORKSPACE_ROOT}/cargo-make/scripts"

# Database configuration (can be overridden)
DATABASE_URL = { value = "postgresql://tasker:tasker@localhost:5432/tasker_rust_test", condition = { env_not_set = ["DATABASE_URL"] } }
TASKER_ENV = { value = "test", condition = { env_not_set = ["TASKER_ENV"] } }

# Worker paths for iteration
WORKER_PATHS = "workers/python,workers/ruby,workers/typescript,workers/rust"
```

#### `cargo-make/cross-cutting.toml`
```toml
# =============================================================================
# Cross-Cutting Concerns - Tasks spanning multiple languages/contexts
# =============================================================================

[tasks.code-quality]
description = "Run all quality checks across all languages"
dependencies = ["check-rust", "check-python", "check-ruby", "check-typescript"]

[tasks.pre-commit]
description = "Pre-commit checks (fast)"
dependencies = ["rust-fmt-check", "rust-clippy"]

[tasks.pre-push]
description = "Pre-push validation (thorough)"
dependencies = ["check-rust", "rust-doctests"]

[tasks.workspace-format-all]
description = "Format all code in parallel"
run_task = { name = ["format-fix-rust", "fix-python", "fix-ruby", "fix-typescript"], fork = true, parallel = true }

[tasks.workspace-lint-all]
description = "Lint all code in parallel"
run_task = { name = ["lint", "check-python", "check-ruby", "check-typescript"], fork = true, parallel = true }
```

#### `cargo-make/test-tasks.toml`
```toml
# =============================================================================
# Test Tasks - Nextest profiles and test infrastructure
# =============================================================================

[tasks.test-all]
description = "Run all tests sequentially"
dependencies = ["test-rust", "test-python", "test-ruby", "test-typescript"]

[tasks.test-ffi-all]
description = "Run all FFI integration tests"
dependencies = ["test-python-ffi", "test-ruby-ffi", "test-typescript-ffi"]

[tasks.test-e2e]
description = "Run E2E tests (requires services running)"
dependencies = ["check-services"]
command = "cargo"
args = ["nextest", "run", "--all-features", "-E", "test(e2e::)"]

[tasks.check-services]
description = "Check required services are running"
script = { file = "${SCRIPTS_DIR}/check-services.sh" }

[tasks.test-crate]
description = "Test a specific crate with nextest"
command = "cargo"
args = ["nextest", "run", "--package", "${CRATE_NAME}", "--all-features"]
```

#### `cargo-make/ci-integration.toml`
```toml
# =============================================================================
# CI Integration Tasks - Bridge between cargo-make and GitHub Actions
# =============================================================================
#
# These tasks align with .github/workflows/ and can be used locally
# to simulate CI behavior.
#
# =============================================================================

[tasks.ci-setup]
description = "Setup CI environment (mirrors .github/actions/setup-env)"
script = { file = "${SCRIPTS_DIR}/setup-env.sh" }

[tasks.ci-build-workers]
description = "Build all workers (aligns with build-workers.yml)"
dependencies = ["build-rust", "build-ruby", "build-python", "build-typescript"]

[tasks.ci-test-rust]
description = "Run Rust tests with CI profile"
command = "cargo"
args = ["nextest", "run", "--all-features", "--profile", "ci"]

[tasks.ci-test-framework]
description = "Run all framework tests"
dependencies = ["test-ruby", "test-python", "test-typescript"]

[tasks.ci-start-services]
description = "Start all services for testing (uses existing CI script)"
script = { file = "${WORKSPACE_ROOT}/.github/scripts/start-native-services.sh" }

[tasks.ci-stop-services]
description = "Stop all services (uses existing CI script)"
script = { file = "${WORKSPACE_ROOT}/.github/scripts/stop-native-services.sh" }

[tasks.ci-flow]
description = "Complete CI flow (mirrors ci.yml workflow)"
dependencies = [
    "ci-setup",
    "ci-build-workers",
    "ci-test-rust",
    "ci-test-framework"
]

[tasks.ci-code-quality]
description = "CI code quality checks (mirrors code-quality.yml)"
dependencies = [
    "rust-fmt-check",
    "rust-clippy",
    "rust-docs",
    "rust-audit"
]
```

### Root Makefile.toml Updates

The root Makefile.toml will be updated to:
1. Add `extend` for all base configuration files
2. Replace inline scripts with script file references
3. Add missing FFI test delegation for Ruby and Python
4. Keep existing well-structured task organization

Key changes:
```toml
[config]
default_to_workspace = false
skip_core_tasks = true

# Extend all base configurations
extend = [
    { path = "./cargo-make/base-tasks.toml" },
    { path = "./cargo-make/workspace-config.toml" },
    { path = "./cargo-make/test-tasks.toml" },
    { path = "./cargo-make/cross-cutting.toml" },
    { path = "./cargo-make/ci-integration.toml" }
]

# Database tasks use script files
[tasks.db-check]
description = "Check database connectivity"
script = { file = "${SCRIPTS_DIR}/check-db.sh" }

[tasks.db-migrate]
description = "Run database migrations"
script = { file = "${SCRIPTS_DIR}/run-migrations.sh" }

# ... etc
```

### Worker Makefile.toml Updates

#### TypeScript Worker (Add setup alias)
```toml
# Add to workers/typescript/Makefile.toml
[tasks.setup]
description = "Setup TypeScript worker (alias for install)"
alias = "install"
```

#### Ruby Worker (Add FFI test task)
```toml
# Add to workers/ruby/Makefile.toml
[tasks.test-ffi]
description = "Run Ruby FFI integration tests"
dependencies = ["build"]
command = "bundle"
args = ["exec", "rspec", "spec/integration/", "--format", "documentation"]
```

#### Python Worker (Add FFI test task)
```toml
# Add to workers/python/Makefile.toml
[tasks.test-ffi]
description = "Run Python FFI integration tests"
dependencies = ["build"]
command = "uv"
args = ["run", "pytest", "tests/integration/", "-v"]
```

### New Makefile.toml Files

#### `workers/rust/Makefile.toml`
```toml
[config]
default_to_workspace = false
skip_core_tasks = true

extend = { path = "../../cargo-make/base-tasks.toml" }

[env]
CRATE_NAME = "tasker-worker-rust"

[tasks.default]
alias = "check"

[tasks.check]
description = "Run Rust worker quality checks"
dependencies = ["format-check", "lint", "test"]

[tasks.build]
extend = "base-rust-build"
args = ["build", "-p", "${CRATE_NAME}", "--all-features"]

[tasks.build-release]
extend = "base-rust-build-release"
args = ["build", "-p", "${CRATE_NAME}", "--all-features", "--release"]

[tasks.format-check]
extend = "base-rust-format"

[tasks.format-fix]
extend = "base-rust-format-fix"

[tasks.lint]
extend = "base-rust-lint"

[tasks.lint-fix]
extend = "base-rust-lint-fix"

[tasks.test]
extend = "base-rust-test"
args = ["nextest", "run", "-p", "${CRATE_NAME}", "--all-features"]

[tasks.fix]
description = "Fix all fixable issues"
dependencies = ["format-fix", "lint-fix"]

[tasks.clean]
description = "Clean build artifacts"
command = "cargo"
args = ["clean", "-p", "${CRATE_NAME}"]

[tasks.run]
description = "Run the Rust worker"
command = "cargo"
args = ["run", "-p", "${CRATE_NAME}", "--all-features"]

[tasks.run-release]
description = "Run the Rust worker (release)"
command = "cargo"
args = ["run", "-p", "${CRATE_NAME}", "--all-features", "--release"]

[tasks.setup]
description = "Setup (no-op for Rust worker)"
script = '''echo "âœ“ Rust worker has no setup requirements"'''
```

#### Library Crate Template (tasker-pgmq, tasker-client, tasker-shared)
```toml
[config]
default_to_workspace = false

extend = { path = "../cargo-make/base-tasks.toml" }

[env]
CRATE_NAME = "<crate-name>"  # Replace with actual crate name

[tasks.default]
alias = "check"

[tasks.check]
description = "Run quality checks"
dependencies = ["format-check", "lint", "test"]

[tasks.format-check]
extend = "base-rust-format"

[tasks.format-fix]
extend = "base-rust-format-fix"

[tasks.lint]
extend = "base-rust-lint"

[tasks.lint-fix]
extend = "base-rust-lint-fix"

[tasks.test]
extend = "base-rust-test"
args = ["nextest", "run", "-p", "${CRATE_NAME}", "--all-features"]

[tasks.fix]
description = "Fix all fixable issues"
dependencies = ["format-fix", "lint-fix"]

[tasks.clean]
description = "Clean build artifacts"
command = "cargo"
args = ["clean", "-p", "${CRATE_NAME}"]
```

#### Service Crate Template (tasker-orchestration, tasker-worker)

Same as library template PLUS:
```toml
[tasks.run]
description = "Run service in foreground"
command = "cargo"
args = ["run", "-p", "${CRATE_NAME}", "--all-features"]

[tasks.run-release]
description = "Run service in foreground (release)"
command = "cargo"
args = ["run", "-p", "${CRATE_NAME}", "--all-features", "--release"]
```

## Implementation Plan

### Phase 1: Foundation
1. Create `cargo-make/` directory
2. Create `cargo-make/scripts/` with all shell scripts
3. Make all scripts executable: `chmod +x cargo-make/scripts/*.sh`
4. Create `cargo-make/base-tasks.toml`
5. Create `cargo-make/workspace-config.toml`
6. Create `cargo-make/cross-cutting.toml`
7. Create `cargo-make/test-tasks.toml`
8. Create `cargo-make/ci-integration.toml`

### Phase 2: Missing Makefiles
1. Create `workers/rust/Makefile.toml`
2. Create `tasker-pgmq/Makefile.toml`
3. Create `tasker-client/Makefile.toml`
4. Create `tasker-shared/Makefile.toml`
5. Create `tasker-orchestration/Makefile.toml`
6. Create `tasker-worker/Makefile.toml`

### Phase 3: Worker Updates
1. Add `setup` alias to `workers/typescript/Makefile.toml`
2. Add `test-ffi` task to `workers/ruby/Makefile.toml`
3. Add `test-ffi` task to `workers/python/Makefile.toml`
4. Update all workers to use `extend` pattern

### Phase 4: Root Refactor
1. Update root `Makefile.toml` to use `extend`
2. Replace inline scripts with script file references
3. Add FFI test delegation for Ruby and Python
4. Verify all delegated tasks work correctly

### Phase 5: Validation & Testing
1. Test `cargo make check` from root
2. Test `cargo make test` from root
3. Test `cargo make build` from root
4. Test each worker's tasks individually
5. Test CI tasks locally
6. Verify nextest profiles work correctly
7. Run full E2E test suite

## Migration Strategy

### No Backward Compatibility Required

This is a greenfield, pre-alpha open source project. No backward compatibility shims are needed.

### Rollback Plan

If issues arise:
1. Git revert of the `cargo-make/` directory removes all new infrastructure
2. Root `Makefile.toml` changes can be reverted independently
3. Worker Makefiles maintain their current functionality
4. CI workflows can fall back to direct commands

## Success Criteria

1. âœ… All actions use consistent naming (`check`, `test`, `fix`, `build`, `setup`)
2. âœ… All workers have consistent `setup` task
3. âœ… All workspace crates have Makefile.toml
4. âœ… `workers/rust/Makefile.toml` exists
5. âœ… `cargo-make/` directory with shared templates
6. âœ… All shell scripts extracted to `cargo-make/scripts/`
7. âœ… FFI test delegation for all workers from root
8. âœ… Nextest remains default for Rust tests
9. âœ… CI tasks can use existing `.github/scripts/`
10. âœ… TypeScript multi-runtime FFI testing preserved
11. âœ… Port 8085 documented for TypeScript (not 8084)
12. âœ… `extends` pattern used in all Makefile.toml files

## Testing Plan

1. Verify `cargo make` with no arguments shows help
2. Verify `cargo make check` runs all quality checks
3. Verify `cargo make test` runs all tests
4. Verify `cargo make build` builds everything
5. Verify each crate's tasks work independently
6. Verify worker delegation works correctly
7. Verify CI tasks align with GitHub Actions workflows
8. Verify nextest profiles (default, ci, local) work
9. Verify doctests run correctly (cargo test, not nextest)
10. Verify all shell scripts execute without errors

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Breaking existing workflows | Implement incrementally, test at each step |
| Parallel execution conflicts | Only parallelize read-only operations |
| Complex inheritance chains | Keep to 2-level depth max |
| Path resolution issues | Use `${WORKSPACE_ROOT}` and `${SCRIPTS_DIR}` |
| Script execution permissions | Verify permissions in Phase 1 |

## Dependencies

- cargo-make (latest version for `extends` support)
- cargo-nextest (for Rust testing)
- All language toolchains (rust, python, ruby, node/bun)
- PostgreSQL with PGMQ for testing
- sqlx-cli (for migrations)

## Notes

- Port 8084 is deliberately avoided due to Mono XSP4 conflict on GitHub Actions runners
- TypeScript uses Biome for unified linting/formatting (not separate tools)
- TypeScript generates bindings via `ts-rs` from Rust DTOs
- Existing `.github/scripts/` are reused, not duplicated
- Existing `.github/actions/` patterns inform local setup scripts
