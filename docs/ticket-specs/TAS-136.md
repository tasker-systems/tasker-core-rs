# TAS-136: Refactor Legacy Data Schema Elements

## Summary

Remove vestigial schema elements inherited from the original Rails Engine prototype that no longer serve the distributed Rust-based architecture. This includes dropping unused tables (annotations, dependent systems), removing deprecated columns (bypass_steps, skippable), and documenting JSONB column semantics for clarity.

## Relationship to Other Tickets

| Ticket | Relationship | Status |
|--------|-------------|--------|
| **TAS-128** | Schema flattening and pg18 migration - established baseline | **Complete** |
| **TAS-78** | Established migrations/tasker/ structure | Complete |
| **TAS-112** | Defined batch processing JSONB shapes | Complete |
| **TAS-125** | Added checkpoint column for batch resumption | Complete |

**Implementation Note**: TAS-128 established the flattened migration baseline in `migrations/`. TAS-136 will archive the current migrations and modify them in-place to remove legacy elements, following the same pattern used in TAS-128.

## Problem Statement

The current schema contains elements from an earlier Rails Engine prototype that predate the distributed Rust orchestration architecture:

1. **Dependent Systems Tables**: `tasker_dependent_systems` and `tasker_dependent_system_object_maps` were designed for a tightly-coupled environment. The "dependent system" concept conflates typology/categorization with relational hierarchy—it's really just a label on steps, not a meaningful entity relationship.

2. **Task Annotations Tables**: `tasker_annotation_types` and `tasker_task_annotations` implement an EAV-lite pattern that overlaps with the existing `tasks.tags` (JSONB with GIN indexes) and `tasks.context` (workflow input payload) columns.

3. **Deprecated Workflow Concepts**: `bypass_steps` and `skippable` columns represent a superseded approach to conditional execution. Conditional workflows (decision points, deferred steps) provide a far more powerful and explicit mechanism.

4. **Foreign Key Dependency**: `tasker_named_steps.dependent_system_uuid` creates a mandatory FK relationship to a vestigial table.

## Analysis Summary

### Tables to Drop

| Table | Original Intent | Why Remove |
|-------|-----------------|------------|
| `tasker_annotation_types` | Registry of annotation categories | Overlaps with `tags` JSONB; EAV-lite pattern adds complexity without benefit |
| `tasker_task_annotations` | Task-level annotations | Same as above; `tags` and `context` serve all annotation use cases |
| `tasker_dependent_systems` | External system registry | Vestigial; serves only as a label on named_steps, not a meaningful relationship |
| `tasker_dependent_system_object_maps` | Cross-system ID correlation | Observability concern, not workflow orchestration; better served by distributed tracing |

### Columns to Drop

| Table.Column | Original Intent | Why Remove |
|--------------|-----------------|------------|
| `tasker_tasks.bypass_steps` | List of steps to skip | Superseded by conditional workflows (decision points) |
| `tasker_workflow_steps.skippable` | Mark step as skippable | Superseded by conditional workflows |
| `tasker_named_tasks_named_steps.skippable` | Template-level skippable default | Superseded by conditional workflows |
| `tasker_named_steps.dependent_system_uuid` | FK to dependent_systems | Table being dropped; column serves no purpose without it |

### Indexes to Drop

| Index | Reason |
|-------|--------|
| `idx_tasker_dependent_systems_name` | Table being dropped |
| `idx_tasker_task_annotations_task_uuid` | Table being dropped |
| `idx_tasker_task_annotations_type_id` | Table being dropped |
| `idx_tasker_named_steps_system_uuid` | Column being dropped |

### Foreign Keys to Drop

| Constraint | Reason |
|------------|--------|
| `tasker_named_steps_dependent_system_uuid_fkey` | Target table being dropped |
| `tasker_task_annotations_task_uuid_fkey` | Table being dropped |
| `tasker_task_annotations_annotation_type_id_fkey` | Table being dropped |
| `tasker_dependent_system_object_maps_dependent_system_one_uuid_fkey` | Table being dropped |
| `tasker_dependent_system_object_maps_dependent_system_two_uuid_fkey` | Table being dropped |

### Elements to Keep (with rationale)

#### Legacy State Columns (Keep)

| Column | Rationale |
|--------|-----------|
| `tasker_workflow_steps.in_process` | Enables efficient partial indexes for active step queries |
| `tasker_workflow_steps.processed` | Same; `WHERE processed = false` is a hot path |
| `tasker_workflow_steps.processed_at` | Useful for analytics without joining to transitions |
| `tasker_tasks.complete` | Enables efficient `WHERE complete = false` filtering |
| `tasker_tasks.completed_at` | Useful for analytics without joining to transitions |

These columns are "denormalized for performance" - the state machine is the source of truth, but these columns enable covering indexes that significantly improve query performance for active workflow queries. The Rust state machine callbacks ensure consistency.

#### JSONB Columns (Keep, Document)

| Column | Semantic Role | Shape Contract |
|--------|---------------|----------------|
| `tasks.context` | **Workflow Input** - Ground state payload for all steps | Application-defined; passed to all handlers |
| `tasks.tags` | **Filtering/Classification** - Queryable operational metadata | Application-defined; GIN-indexed |
| `workflow_steps.inputs` | **Step Input** - Polymorphic by step type | Determined by handler type (batch cursor, decision params, etc.) |
| `workflow_steps.results` | **Step Output** - Standardized execution result | `StepExecutionResult` struct |
| `workflow_steps.checkpoint` | **Resumption State** - Handler-driven batch progress | `CheckpointData` struct |
| `named_tasks.configuration` | **Template Settings** - Lifecycle thresholds, defaults | Lifecycle config with GIN index on `lifecycle` path |

**JSONB Design Decision**: Structural validation belongs at the application layer (Rust structs, Pydantic models, etc.), not database constraints. This provides flexibility during rapid iteration while maintaining type safety where it matters (in code).

#### Named Steps Structure (Keep)

The current `named_steps` table with only name/description is intentionally minimal. Step configuration belongs on `named_tasks_named_steps` (the join table) because step behavior is context-dependent—the same step type may have different retry policies in different task templates.

## Implementation Plan

### Phase 0: Remove Legacy `db/` Directory

The `db/` directory at the project root contains historical artifacts from the Rails Engine prototype that are **not used** by the Rust codebase:

| Path | Contents | Action |
|------|----------|--------|
| `db/structure.sql` | Legacy Rails schema dump (`public.tasker_*` with integer IDs) | Delete |
| `db/query-scopes/*.sql` | Generated SQL from Rails ActiveRecord scopes | Delete entire directory |

These files are preserved in git history but serve no purpose in the Rust architecture. Remove the entire `db/` directory.

### Phase 1: Schema Changes

Since this is a greenfield pre-alpha project with no production deployments, these changes are implemented by modifying the migration baseline rather than adding DROP migrations.

**Archive Pattern** (following TAS-128):
```bash
# 1. Archive current migrations for reference
mkdir -p migrations/archive/tas-136
cp migrations/20260110000001_schema_and_tables.sql migrations/archive/tas-136/
cp migrations/20260110000002_constraints_and_indexes.sql migrations/archive/tas-136/

# 2. Modify migrations in-place (not DROP statements)
```

**Migration Files to Modify**:

| File | Changes |
|------|---------|
| `20260110000001_schema_and_tables.sql` | Remove table definitions and columns |
| `20260110000002_constraints_and_indexes.sql` | Remove related constraints and indexes |

**Elements to Remove from `20260110000001_schema_and_tables.sql`**:
- `CREATE TABLE tasker.annotation_types` (and sequence)
- `CREATE TABLE tasker.task_annotations` (and sequence)
- `CREATE TABLE tasker.dependent_systems`
- `CREATE TABLE tasker.dependent_system_object_maps` (and sequence)
- `dependent_system_uuid` column from `named_steps` table
- `skippable` column from `named_tasks_named_steps` table
- `skippable` column from `workflow_steps` table
- `bypass_steps` column from `tasks` table

**Elements to Remove from `20260110000002_constraints_and_indexes.sql`**:
- All PRIMARY KEY, UNIQUE, and FK constraints for dropped tables
- `named_steps_system_name_unique` constraint (references `dependent_system_uuid`)
- All indexes on dropped tables/columns

### Phase 2: Rust Code Cleanup

Remove all references to dropped schema elements from Rust codebase.

#### Source Models to Remove/Modify

| File | Change |
|------|--------|
| `tasker-shared/src/models/core/annotation_type.rs` | Delete file |
| `tasker-shared/src/models/core/task_annotation.rs` | Delete file |
| `tasker-shared/src/models/core/dependent_system.rs` | Delete file |
| `tasker-shared/src/models/core/dependent_system_object_map.rs` | Delete file |
| `tasker-shared/src/models/core/named_step.rs` | Remove `dependent_system_uuid` field |
| `tasker-shared/src/models/core/named_tasks_named_step.rs` | Remove `skippable` field |
| `tasker-shared/src/models/core/task.rs` | Remove `bypass_steps` field |
| `tasker-shared/src/models/core/workflow_step.rs` | Remove `skippable` field |
| `tasker-shared/src/models/core/mod.rs` | Remove module exports for deleted models |

#### Test Models to Remove/Modify

| File | Change |
|------|--------|
| `tasker-shared/tests/models/core/annotation_type.rs` | Delete file |
| `tasker-shared/tests/models/core/task_annotation.rs` | Delete file |
| `tasker-shared/tests/models/core/dependent_system.rs` | Delete file |
| `tasker-shared/tests/models/core/dependent_system_object_map.rs` | Delete file |
| `tasker-shared/tests/models/core/named_step.rs` | Update for removed field |
| `tasker-shared/tests/models/core/mod.rs` | Remove module exports for deleted models |

#### SQLx Query Cache

After schema and model changes, regenerate the SQLx query cache:

```bash
DATABASE_URL=postgresql://tasker:tasker@localhost:5432/tasker_rust_test \
cargo sqlx prepare --workspace -- --all-targets --all-features

git add .sqlx/
```

**Note**: The `.sqlx/` cache files in `tasker-shared/` and `workers/rust/` will be automatically updated by this command. Files referencing removed columns will be regenerated or removed.

### Phase 3: Worker SDK Cleanup

Remove references from polyglot worker implementations.

#### Ruby (`workers/ruby/`)

| File | Change |
|------|--------|
| `lib/tasker_core/models.rb` | Remove `skippable` references |
| `lib/tasker_core/types/task_types.rb` | Remove `bypass_steps` from task types |

#### Python (`workers/python/`)

| File | Change |
|------|--------|
| `python/tasker_core/models.py` | Remove `skippable` from step types, `bypass_steps` from task types |

#### TypeScript (`workers/typescript/`)

| File | Change |
|------|--------|
| `src/ffi/generated/WorkflowStepDto.ts` | Remove `skippable` field |
| `src-rust/dto.rs` | Remove `skippable` field from DTO |
| Various test files | Update to remove references to `skippable` |

**Test files requiring updates** (found via grep):
- `tests/unit/handler/registry.test.ts`
- `tests/unit/types/step-context.test.ts`
- `tests/unit/subscriber/step-execution-subscriber.test.ts`
- `tests/unit/handler/base.test.ts`
- `tests/unit/ffi/types.test.ts`
- `tests/unit/events/event-emitter.test.ts`
- `tests/integration/event-flow.test.ts`

#### Rust Worker (`workers/rust/`)

| File | Change |
|------|--------|
| `src/step_handlers/*.rs` | Review for `skippable`/`bypass_steps` references |
| `src/event_subscribers/*.rs` | Review for legacy field references |

### Phase 4: Documentation Updates

#### Architecture Documentation

Create or update `docs/architecture/schema-design.md` with:

1. **JSONB Column Semantics**: Document the role and shape contracts for each JSONB column
2. **Inputs Polymorphism**: Explain that `workflow_steps.inputs` shape is determined by handler type
3. **Denormalized State Columns**: Document that `complete`, `processed`, `in_process` are performance optimizations maintained by state machine callbacks
4. **Design Decisions**: Capture the rationale for keeping certain elements

#### Migration Comments

Add comprehensive comments to the flattened migration explaining:
- Why certain JSONB columns exist and their contracts
- Why legacy state columns are kept (performance)
- Reference to architecture documentation

### Phase 5: Test Updates

- Remove any tests that reference dropped tables/columns
- Verify all SQLx queries compile after changes
- Run full test suite

## Code Search Patterns

Use these patterns to find all references that need updating:

```bash
# Find dependent_system references
rg -l "dependent_system" --type rust --type sql --type ruby --type python --type ts

# Find annotation references
rg -l "annotation_type|task_annotation" --type rust --type sql --type ruby --type python --type ts

# Find bypass_steps references
rg -l "bypass_steps" --type rust --type sql --type ruby --type python --type ts

# Find skippable references (careful: may have legitimate uses in other contexts)
rg -l "skippable" --type rust --type sql --type ruby --type python --type ts
```

## Alternative Approaches Considered

### Dependent Systems → String Category

**Considered**: Replace `dependent_system_uuid` FK with `system_category varchar(64)` to preserve categorization capability.

**Rejected**: The categorization adds no value to the current architecture. If categorization is needed in the future, it can be added to handler metadata or step tags. Removing the concept entirely is cleaner.

### Keep Object Maps for Observability

**Considered**: Migrate `dependent_system_object_maps` to a separate observability schema.

**Rejected**: Cross-system ID correlation is better handled by distributed tracing (correlation_id, OpenTelemetry). Adding a separate schema for a vestigial pattern adds complexity. Future observability needs should be addressed with purpose-built solutions.

### Database-Level JSON Schema Validation

**Considered**: Add CHECK constraints with JSON Schema validation for JSONB columns.

**Rejected**: Maintenance overhead and migration burden outweigh benefits at this stage. Application-layer validation with Rust structs, Pydantic models, etc. provides equivalent safety with more flexibility. Can be revisited when schema stabilizes.

## Validation Checklist

### Pre-Implementation
- [ ] Migrations archived to `migrations/archive/tas-136/`

### Legacy Cleanup
- [ ] `db/` directory removed entirely (structure.sql, query-scopes/)

### Schema Validation
- [ ] Tables removed from migrations: `annotation_types`, `task_annotations`, `dependent_systems`, `dependent_system_object_maps`
- [ ] Columns removed from migrations: `bypass_steps`, `skippable` (on steps), `skippable` (on ntns), `dependent_system_uuid`
- [ ] Indexes removed: All indexes on dropped tables/columns
- [ ] Foreign keys removed: All FKs to dropped tables
- [ ] Sequences removed: All sequences for dropped tables

### Code Validation
- [ ] Rust model files deleted: `annotation_type.rs`, `task_annotation.rs`, `dependent_system.rs`, `dependent_system_object_map.rs`
- [ ] Rust model files updated: `named_step.rs`, `named_tasks_named_step.rs`, `task.rs`, `workflow_step.rs`
- [ ] Test model files cleaned up
- [ ] `cargo sqlx prepare --workspace` succeeds
- [ ] `cargo build --workspace` succeeds
- [ ] `cargo test --workspace` passes
- [ ] `cargo make check` passes (all quality checks)

### Documentation Validation
- [ ] `docs/architecture/schema-design.md` exists with JSONB documentation
- [ ] Migration comments explain design decisions
- [ ] Any architecture docs referencing dropped elements are updated

### Cross-Language Validation
- [ ] Ruby worker: `bundle exec rspec` passes
- [ ] Python worker: `uv run pytest` passes
- [ ] TypeScript worker: `bun test` passes
- [ ] Full CI pipeline passes

## Success Criteria

1. ✅ Legacy `db/` directory removed (structure.sql, query-scopes/)
2. ✅ No tables exist for annotations or dependent systems in migrations
3. ✅ No `bypass_steps` or `skippable` columns exist in migrations
4. ✅ `named_steps` table has no FK to dependent_systems
5. ✅ All Rust code compiles without references to dropped elements
6. ✅ All worker SDKs compile/pass type checks
7. ✅ Full test suite passes (including CI)
8. ✅ JSONB column semantics documented in architecture docs
9. ✅ Migration comments explain schema design decisions

## Appendix: Full List of Removed Elements

### Legacy Directory (entire `db/` directory)
```
db/structure.sql                              # Legacy Rails schema dump
db/query-scopes/tasker_named_task_scopes.sql
db/query-scopes/tasker_named_tasks_named_step_scopes.sql
db/query-scopes/tasker_step_dag_relationship_scopes.sql
db/query-scopes/tasker_task_namespace_scopes.sql
db/query-scopes/tasker_task_scopes.sql
db/query-scopes/tasker_task_transition_scopes.sql
db/query-scopes/tasker_workflow_step_edge_scopes.sql
db/query-scopes/tasker_workflow_step_scopes.sql
db/query-scopes/tasker_workflow_step_transition_scopes.sql
```

### Tables (4)
```
tasker.annotation_types
tasker.task_annotations
tasker.dependent_systems
tasker.dependent_system_object_maps
```

### Columns (4)
```
tasker.tasks.bypass_steps
tasker.workflow_steps.skippable
tasker.named_tasks_named_steps.skippable
tasker.named_steps.dependent_system_uuid
```

### Indexes (removed with tables/columns)
```
idx_annotation_types_name
idx_task_annotations_task_uuid
idx_task_annotations_type_id
idx_named_steps_system_uuid
idx_dependent_systems_name
```

### Foreign Keys (removed with tables)
```
named_steps_dependent_system_uuid_fkey
task_annotations_task_uuid_fkey
task_annotations_annotation_type_id_fkey
dependent_system_object_maps_dependent_system_one_uuid_fkey
dependent_system_object_maps_dependent_system_two_uuid_fkey
```

### Sequences (removed with tables)
```
tasker.annotation_types_annotation_type_id_seq
tasker.task_annotations_task_annotation_id_seq
tasker.dependent_system_objec_dependent_system_object_map_i_seq
```

### Unique Constraints (removed with tables)
```
annotation_types_name_key
annotation_types_name_unique
dependent_systems_name_key
dependent_systems_name_unique
named_steps_system_name_unique  # references dependent_system_uuid
```

### Rust Model Files (deleted)
```
tasker-shared/src/models/core/annotation_type.rs
tasker-shared/src/models/core/task_annotation.rs
tasker-shared/src/models/core/dependent_system.rs
tasker-shared/src/models/core/dependent_system_object_map.rs
tasker-shared/tests/models/core/annotation_type.rs
tasker-shared/tests/models/core/task_annotation.rs
tasker-shared/tests/models/core/dependent_system.rs
tasker-shared/tests/models/core/dependent_system_object_map.rs
```
