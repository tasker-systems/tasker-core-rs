# Tasker V2 Worker Configuration (Base)
# Worker-specific settings

[worker]
worker_id = "worker-default-001"
worker_type = "general"

[worker.event_systems.worker]
system_id = "worker-event-system"
deployment_mode = "Hybrid"

[worker.event_systems.worker.timing]
health_check_interval_seconds = 30
fallback_polling_interval_seconds = 2
visibility_timeout_seconds = 30
processing_timeout_seconds = 60
claim_timeout_seconds = 300

[worker.event_systems.worker.processing]
max_concurrent_operations = 100
batch_size = 20
max_retries = 3

[worker.event_systems.worker.processing.backoff]
initial_delay_ms = 100
max_delay_ms = 10000
multiplier = 2.0
jitter_percent = 0.1

[worker.event_systems.worker.health]
enabled = true
performance_monitoring_enabled = true
max_consecutive_errors = 10
error_rate_threshold_per_minute = 20

[worker.event_systems.worker.metadata.in_process_events]
ffi_integration_enabled = true
deduplication_cache_size = 10000

[worker.event_systems.worker.metadata.listener]
retry_interval_seconds = 5
max_retry_attempts = 5
event_timeout_seconds = 60
batch_processing = true
connection_timeout_seconds = 30

[worker.event_systems.worker.metadata.fallback_poller]
enabled = true
polling_interval_ms = 1000
batch_size = 20
age_threshold_seconds = 5
max_age_hours = 24
visibility_timeout_seconds = 30
supported_namespaces = []

[worker.event_systems.worker.metadata.resource_limits]
max_memory_mb = 4096
max_cpu_percent = 80.0
max_database_connections = 100
max_queue_connections = 50

[worker.step_processing]
claim_timeout_seconds = 300
max_retries = 3
max_concurrent_steps = 50

[worker.health_monitoring]
health_check_interval_seconds = 30
performance_monitoring_enabled = true
error_rate_threshold = 0.05

[worker.mpsc_channels.command_processor]
command_buffer_size = 2000

[worker.mpsc_channels.event_systems]
event_channel_buffer_size = 2000

[worker.mpsc_channels.event_subscribers]
completion_buffer_size = 1000
result_buffer_size = 1000

# TAS-65: In-process event bus configuration for fast domain event delivery
[worker.mpsc_channels.in_process_events]
broadcast_buffer_size = 2000
log_subscriber_errors = true
dispatch_timeout_ms = 5000

[worker.mpsc_channels.event_listeners]
pgmq_event_buffer_size = 10000

# TAS-65/TAS-69: Domain Event System MPSC Configuration
[worker.mpsc_channels.domain_events]
command_buffer_size = 1000
shutdown_drain_timeout_ms = 5000
log_dropped_events = true

# TAS-67: Handler Dispatch System MPSC Configuration
[worker.mpsc_channels.handler_dispatch]
dispatch_buffer_size = 1000
completion_buffer_size = 1000
max_concurrent_handlers = 10
handler_timeout_ms = 30000

# TAS-67: FFI Dispatch Channel Configuration
[worker.mpsc_channels.ffi_dispatch]
dispatch_buffer_size = 1000
completion_timeout_ms = 30000
# TAS-67 Risk Mitigation: Fire-and-forget callback timeout
# Prevents indefinite blocking of FFI threads during domain event publishing
callback_timeout_ms = 5000

# Orchestration Client Configuration
# How the worker connects to the orchestration API
[worker.orchestration_client]
base_url = "http://localhost:8080"
timeout_ms = 30000
max_retries = 3

[worker.web]
enabled = true
bind_address = "${TASKER_WEB_BIND_ADDRESS:-0.0.0.0:8081}"
request_timeout_ms = 30000

[worker.web.database_pools]
web_api_pool_size = 10
web_api_max_connections = 15
web_api_connection_timeout_seconds = 30
web_api_idle_timeout_seconds = 600
max_total_connections_hint = 25

# TAS-61: Removed [worker.web.cors] - CORS uses hardcoded tower_http::cors::Any in middleware

[worker.web.auth]
enabled = false
jwt_issuer = "tasker-worker"
jwt_audience = "worker-api"
jwt_token_expiry_hours = 24
jwt_private_key = ""
jwt_public_key = ""
api_key = ""
api_key_header = "X-API-Key"

[[worker.web.auth.protected_routes]]
method = "GET"
path = "/status/detailed"
auth_type = "bearer"
required = false

[[worker.web.auth.protected_routes]]
method = "GET"
path = "/handlers"
auth_type = "bearer"
required = false

[[worker.web.auth.protected_routes]]
method = "DELETE"
path = "/templates/cache"
auth_type = "bearer"
required = true

[[worker.web.auth.protected_routes]]
method = "POST"
path = "/templates/cache/maintain"
auth_type = "bearer"
required = true

[[worker.web.auth.protected_routes]]
method = "POST"
path = "/templates/{namespace}/{name}/{version}/refresh"
auth_type = "bearer"
required = true

# TAS-61: Removed [worker.web.rate_limiting] - no rate limiting middleware implemented

[worker.web.resilience]
circuit_breaker_enabled = true
# TAS-61: Removed request_timeout_seconds - timeout hardcoded in middleware (30s)
# TAS-61: Removed max_concurrent_requests - no concurrency limiting implemented
