# Tasker V2 Complete Configuration (Test Environment)
# Structured according to tasker_v2_proposal.rs
# This file can be directly deserialized into TaskerConfig

# ============================================================================
# COMMON CONFIGURATION (Shared across all contexts)
# ============================================================================

[common.system]
version = "0.1.0"
default_dependent_system = "default"
max_recursion_depth = 50

[common.database]
url = "postgresql://tasker:tasker@localhost:5432/tasker_rust_test"
database = "tasker_rust_test"
skip_migration_check = false

[common.database.pool]
max_connections = 10
min_connections = 2
acquire_timeout_seconds = 5
idle_timeout_seconds = 60
max_lifetime_seconds = 3600

[common.database.variables]
statement_timeout = 5000

[common.queues]
backend = "pgmq"
orchestration_namespace = "orchestration"
worker_namespace = "worker"
default_visibility_timeout_seconds = 30
default_batch_size = 5
max_batch_size = 100
naming_pattern = "{namespace}_{name}_queue"
health_check_interval = 60

[common.queues.orchestration_queues]
task_requests = "orchestration_task_requests_queue"
task_finalizations = "orchestration_task_finalizations_queue"
step_results = "orchestration_step_results_queue"

[common.queues.pgmq]
poll_interval_ms = 250
shutdown_timeout_seconds = 5
max_retries = 1

[common.queues.rabbitmq]
connection_timeout_seconds = 10

[common.circuit_breakers]
enabled = true

[common.circuit_breakers.global_settings]
max_circuit_breakers = 20
metrics_collection_interval_seconds = 10
min_state_transition_interval_seconds = 1.0

[common.circuit_breakers.default_config]
failure_threshold = 3
timeout_seconds = 5
success_threshold = 1

[common.circuit_breakers.component_configs.task_readiness]
failure_threshold = 5
timeout_seconds = 30
success_threshold = 2

[common.circuit_breakers.component_configs.pgmq]
failure_threshold = 3
timeout_seconds = 15
success_threshold = 2

[common.mpsc_channels.event_publisher]
event_queue_buffer_size = 100

[common.mpsc_channels.ffi]
ruby_event_buffer_size = 100

[common.mpsc_channels.overflow_policy]
log_warning_threshold = 0.8
drop_policy = "block"

[common.mpsc_channels.overflow_policy.metrics]
enabled = true
saturation_check_interval_seconds = 10

[common.execution]
max_concurrent_tasks = 100
max_concurrent_steps = 1000
default_timeout_seconds = 3600
step_execution_timeout_seconds = 300
max_discovery_attempts = 3
step_batch_size = 10
max_retries = 3
max_workflow_steps = 1000
connection_timeout_seconds = 10
environment = "test"

[common.backoff]
default_backoff_seconds = [1, 2, 4]
max_backoff_seconds = 10
backoff_multiplier = 2.0
jitter_enabled = true
jitter_max_percentage = 0.1

[common.backoff.reenqueue_delays]
initializing = 5
enqueuing_steps = 0
steps_in_process = 10
evaluating_results = 5
waiting_for_dependencies = 45
waiting_for_retry = 30
blocked_by_failures = 60

[common.task_templates]
search_paths = ["config/task_templates/*.{yml,yaml}"]

[common.telemetry]
enabled = false
service_name = "tasker-core"
sample_rate = 1.0

# ============================================================================
# ORCHESTRATION CONFIGURATION (Orchestration-specific)
# ============================================================================

[orchestration]
mode = "standalone"
enable_performance_logging = false

[orchestration.event_systems.orchestration]
system_id = "orchestration-event-system"
deployment_mode = "Hybrid"

[orchestration.event_systems.orchestration.timing]
health_check_interval_seconds = 30
fallback_polling_interval_seconds = 5
visibility_timeout_seconds = 30
processing_timeout_seconds = 30
claim_timeout_seconds = 300

[orchestration.event_systems.orchestration.processing]
max_concurrent_operations = 10
batch_size = 10
max_retries = 3

[orchestration.event_systems.orchestration.processing.backoff]
initial_delay_ms = 100
max_delay_ms = 5000
multiplier = 2.0
jitter_percent = 0.1

[orchestration.event_systems.orchestration.health]
enabled = true
performance_monitoring_enabled = true
max_consecutive_errors = 10
error_rate_threshold_per_minute = 5

[orchestration.event_systems.task_readiness]
system_id = "task-readiness-event-system"
deployment_mode = "Hybrid"

[orchestration.event_systems.task_readiness.timing]
health_check_interval_seconds = 30
fallback_polling_interval_seconds = 5
visibility_timeout_seconds = 30
processing_timeout_seconds = 30
claim_timeout_seconds = 300

[orchestration.event_systems.task_readiness.processing]
max_concurrent_operations = 100
batch_size = 50
max_retries = 3

[orchestration.event_systems.task_readiness.processing.backoff]
initial_delay_ms = 100
max_delay_ms = 5000
multiplier = 2.0
jitter_percent = 0.1

[orchestration.event_systems.task_readiness.health]
enabled = true
performance_monitoring_enabled = true
max_consecutive_errors = 10
error_rate_threshold_per_minute = 5

[orchestration.decision_points]
enabled = true
max_steps_per_decision = 50
max_decision_depth = 10
warn_threshold_steps = 20
warn_threshold_depth = 5
enable_detailed_logging = false
enable_metrics = true

[orchestration.mpsc_channels.command_processor]
command_buffer_size = 100

[orchestration.mpsc_channels.event_systems]
event_channel_buffer_size = 100

[orchestration.mpsc_channels.event_listeners]
pgmq_event_buffer_size = 100

[orchestration.web]
enabled = true
bind_address = "0.0.0.0:8080"
request_timeout_ms = 5000

# TLS disabled - omitted from config (optional field)
# [orchestration.web.tls]
# enabled = false
# cert_path = ""
# key_path = ""

[orchestration.web.database_pools]
web_api_pool_size = 10
web_api_max_connections = 15
web_api_connection_timeout_seconds = 30
web_api_idle_timeout_seconds = 600
max_total_connections_hint = 30

[orchestration.web.cors]
enabled = true
allowed_origins = ["*"]
allowed_methods = ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
allowed_headers = ["*"]
max_age_seconds = 86400

[orchestration.web.auth]
enabled = false
jwt_issuer = "tasker-core"
jwt_audience = "tasker-api"
jwt_token_expiry_hours = 24
jwt_private_key = ""
jwt_public_key = ""
api_key = ""
api_key_header = "X-API-Key"

# Protected routes using ergonomic array of tables syntax
[[orchestration.web.auth.protected_routes]]
method = "GET"
path = "/v1/analytics/bottlenecks"
auth_type = "bearer"
required = false

[[orchestration.web.auth.protected_routes]]
method = "PATCH"
path = "/v1/tasks/{task_uuid}/workflow_steps/{step_uuid}"
auth_type = "bearer"
required = true

[[orchestration.web.auth.protected_routes]]
method = "DELETE"
path = "/v1/tasks/{task_uuid}"
auth_type = "bearer"
required = true

[[orchestration.web.auth.protected_routes]]
method = "GET"
path = "/v1/analytics/performance"
auth_type = "bearer"
required = false

[[orchestration.web.auth.protected_routes]]
method = "POST"
path = "/v1/tasks"
auth_type = "bearer"
required = false

[orchestration.web.rate_limiting]
enabled = false
requests_per_minute = 1000
burst_size = 100
per_client_limit = true

[orchestration.web.resilience]
circuit_breaker_enabled = true
request_timeout_seconds = 30
max_concurrent_requests = 100

# ============================================================================
# WORKER CONFIGURATION (Worker-specific)
# ============================================================================

[worker]
worker_id = "test-worker-001"
worker_type = "general"

[worker.event_systems.worker]
system_id = "worker-event-system"
deployment_mode = "Hybrid"

[worker.event_systems.worker.timing]
health_check_interval_seconds = 30
fallback_polling_interval_seconds = 1
visibility_timeout_seconds = 30
processing_timeout_seconds = 30
claim_timeout_seconds = 300

[worker.event_systems.worker.processing]
max_concurrent_operations = 100
batch_size = 10
max_retries = 3

[worker.event_systems.worker.processing.backoff]
initial_delay_ms = 100
max_delay_ms = 5000
multiplier = 2.0
jitter_percent = 0.1

[worker.event_systems.worker.health]
enabled = true
performance_monitoring_enabled = true
max_consecutive_errors = 10
error_rate_threshold_per_minute = 5

[worker.event_systems.worker.metadata.in_process_events]
ffi_integration_enabled = true
deduplication_cache_size = 1000

[worker.event_systems.worker.metadata.listener]
retry_interval_seconds = 5
max_retry_attempts = 3
event_timeout_seconds = 30
batch_processing = true
connection_timeout_seconds = 10

[worker.event_systems.worker.metadata.fallback_poller]
enabled = true
polling_interval_ms = 500
batch_size = 10
age_threshold_seconds = 2
max_age_hours = 12
visibility_timeout_seconds = 30
supported_namespaces = []

[worker.event_systems.worker.metadata.resource_limits]
max_memory_mb = 2048
max_cpu_percent = 80.0
max_database_connections = 50
max_queue_connections = 20

[worker.step_processing]
claim_timeout_seconds = 300
max_retries = 3
max_concurrent_steps = 10

[worker.health_monitoring]
health_check_interval_seconds = 10
performance_monitoring_enabled = true
error_rate_threshold = 0.05

[worker.mpsc_channels.command_processor]
command_buffer_size = 100

[worker.mpsc_channels.event_systems]
event_channel_buffer_size = 100

[worker.mpsc_channels.event_subscribers]
completion_buffer_size = 100
result_buffer_size = 100

[worker.mpsc_channels.in_process_events]
broadcast_buffer_size = 1000

[worker.mpsc_channels.event_listeners]
pgmq_event_buffer_size = 100

[worker.web]
enabled = true
bind_address = "0.0.0.0:8081"
request_timeout_ms = 5000

# TLS disabled - omitted from config (optional field)
# [worker.web.tls]
# enabled = false
# cert_path = ""
# key_path = ""

[worker.web.database_pools]
web_api_pool_size = 5
web_api_max_connections = 10
web_api_connection_timeout_seconds = 15
web_api_idle_timeout_seconds = 300
max_total_connections_hint = 15

[worker.web.cors]
enabled = true
allowed_origins = ["*"]
allowed_methods = ["GET", "POST", "DELETE", "OPTIONS"]
allowed_headers = ["*"]
max_age_seconds = 86400

[worker.web.auth]
enabled = false
jwt_issuer = "tasker-worker"
jwt_audience = "worker-api"
jwt_token_expiry_hours = 24
jwt_private_key = ""
jwt_public_key = ""
api_key = ""
api_key_header = "X-API-Key"

# Protected routes using ergonomic array of tables syntax
[[worker.web.auth.protected_routes]]
method = "GET"
path = "/status/detailed"
auth_type = "bearer"
required = false

[[worker.web.auth.protected_routes]]
method = "DELETE"
path = "/templates/cache"
auth_type = "bearer"
required = true

[[worker.web.auth.protected_routes]]
method = "GET"
path = "/handlers"
auth_type = "bearer"
required = false

[[worker.web.auth.protected_routes]]
method = "POST"
path = "/templates/cache/maintain"
auth_type = "bearer"
required = true

[[worker.web.auth.protected_routes]]
method = "POST"
path = "/templates/{namespace}/{name}/{version}/refresh"
auth_type = "bearer"
required = true

[worker.web.rate_limiting]
enabled = false
requests_per_minute = 500
burst_size = 50
per_client_limit = true

[worker.web.resilience]
circuit_breaker_enabled = true
request_timeout_seconds = 30
max_concurrent_requests = 50
