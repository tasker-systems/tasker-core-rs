# =============================================================================
# Test Compose Configuration - Local Integration Testing (OPTIMIZED)
# =============================================================================
# Optimized for local development and testing:
# - Fast debug builds with optimized Dockerfile.test-local
# - BuildKit cache configuration for faster rebuilds
# - Always builds from local source (no cached images)
# - Minimal resource usage
# - Quick startup times
#
# Usage:
# export DOCKER_BUILDKIT=1
# export COMPOSE_DOCKER_CLI_BUILD=1
# docker-compose -f docker/docker-compose.test-local.yml up --build

services:
  # ==========================================================================
  # PostgreSQL Database with PGMQ Extension
  # ==========================================================================
  postgres:
    build:
      context: ..
      dockerfile: docker/db/Dockerfile
    command:
      - "postgres"
      - "-c"
      - "max_connections=500"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
    environment:
      POSTGRES_DB: tasker_rust_test
      POSTGRES_USER: tasker
      POSTGRES_PASSWORD: tasker
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tasker -d tasker_rust_test"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - tasker-test

  # ==========================================================================
  # Orchestration Service - Optimized Test Build
  # ==========================================================================
  orchestration:
    build:
      context: ..
      dockerfile: docker/build/orchestration.test.Dockerfile
      # OPTIMIZATION: BuildKit cache configuration
      # Note: BuildKit must be enabled via environment variables
      cache_from:
        - type=local,src=/tmp/docker-cache/orchestration
      cache_to:
        - type=local,dest=/tmp/docker-cache/orchestration,mode=max
    environment:
      DATABASE_URL: postgresql://tasker:tasker@postgres:5432/tasker_rust_test
      TASKER_ENV: test
      RUST_LOG: info,tasker_orchestration::orchestration::lifecycle::batch_processing=debug
      LOG_LEVEL: info
      RUST_BACKTRACE: 1
      PORT: 8080
      WORKSPACE_PATH: /app
      # TAS-61 V2: Single-file configuration from v2 directory
      TASKER_CONFIG_PATH: /app/config/tasker/orchestration-test.toml
      # Migration settings
      RUN_MIGRATIONS: "true"
      DEPLOYMENT_MODE: standard
      SKIP_MIGRATION_PROMPT: "true"
      DB_MIGRATION_RETRIES: "3"
      DB_MIGRATION_RETRY_DELAY: "5"
      DB_MIGRATION_TIMEOUT: "120"
    ports:
      - "8080:8080"
    volumes:
      - ../config/tasker:/app/config/tasker:ro
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - tasker-test

  # ==========================================================================
  # Rust Worker Service - Optimized Test Build
  # ==========================================================================
  worker:
    build:
      context: ..
      dockerfile: docker/build/rust-worker.test.Dockerfile
      # OPTIMIZATION: BuildKit cache configuration
      cache_from:
        - type=local,src=/tmp/docker-cache/rust-worker
      cache_to:
        - type=local,dest=/tmp/docker-cache/rust-worker,mode=max
    environment:
      DATABASE_URL: postgresql://tasker:tasker@postgres:5432/tasker_rust_test
      TASKER_ENV: test
      RUST_LOG: info,tasker_worker_rust::step_handlers=debug
      LOG_LEVEL: info
      RUST_BACKTRACE: 1
      WORKER_ID: test-worker-001
      WORKSPACE_PATH: /app
      # TAS-61 V2: Single-file configuration from v2 directory
      TASKER_CONFIG_PATH: /app/config/tasker/worker-test.toml
      # Point to centralized E2E test templates for Rust handlers
      TASKER_TEMPLATE_PATH: /app/tests/fixtures/task_templates/rust
      PORT: 8081
    ports:
      - "8081:8081"
    volumes:
      - ../config/tasker:/app/config/tasker:ro
      # Mount centralized test templates
      - ../tests/fixtures/task_templates/rust:/app/tests/fixtures/task_templates/rust:ro
      # Mount test fixtures for CSV and other data files
      - ../tests/fixtures:/app/tests/fixtures:ro
    depends_on:
      postgres:
        condition: service_healthy
      orchestration:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - tasker-test

  # ==========================================================================
  # Ruby Worker Service - Optimized Test Build with Ruby FFI Support
  # ==========================================================================
  ruby-worker:
    build:
      context: ..
      dockerfile: docker/build/ruby-worker.test.Dockerfile
      # OPTIMIZATION: BuildKit cache configuration
      cache_from:
        - type=local,src=/tmp/docker-cache/ruby-worker
      cache_to:
        - type=local,dest=/tmp/docker-cache/ruby-worker,mode=max
    environment:
      DATABASE_URL: postgresql://tasker:tasker@postgres:5432/tasker_rust_test
      TASKER_ENV: test
      RUST_LOG: info
      LOG_LEVEL: info
      RUST_BACKTRACE: 1
      WORKER_ID: test-ruby-worker-001
      WORKSPACE_PATH: /app
      # TAS-61 V2: Single-file configuration from v2 directory
      TASKER_CONFIG_PATH: /app/config/tasker/worker-test.toml
      # Point to centralized E2E test templates for Ruby handlers
      TASKER_TEMPLATE_PATH: /app/tests/fixtures/task_templates/ruby
      # Ruby environment
      RUBY_WORKER_ENABLED: "true"
      BUNDLE_GEMFILE: /app/ruby_worker/Gemfile
      # Service configuration
      PORT: 8082
    ports:
      - "8082:8081" # Map to 8082 externally, 8081 internally (same as Rust worker)
    volumes:
      - ../config/tasker:/app/config/tasker:ro
      # Mount centralized test templates
      - ../tests/fixtures/task_templates/ruby:/app/tests/fixtures/task_templates/ruby:ro
      # Mount test fixtures for CSV and other data files
      - ../tests/fixtures:/app/tests/fixtures:ro
      # Mount handler source code for discovery (must match Dockerfile structure)
      - ../workers/ruby/spec/handlers:/app/ruby_worker/spec/handlers:ro
    depends_on:
      postgres:
        condition: service_healthy
      orchestration:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 5 # More retries for CI environment
      start_period: 60s # Ruby FFI bootstrap + Rust worker + web API binding can take time in CI
    networks:
      - tasker-test

volumes:
  postgres_data:

networks:
  tasker-test:
    driver: bridge
