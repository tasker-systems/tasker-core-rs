# =============================================================================
# Test Compose Configuration - Local Integration Testing (OPTIMIZED)
# =============================================================================
# Optimized for local development and testing:
# - Fast debug builds with optimized Dockerfile.test-local
# - BuildKit cache configuration for faster rebuilds
# - Always builds from local source (no cached images)
# - Grafana LGTM stack for OpenTelemetry observability (TAS-65 Phase 1)
# - Minimal resource usage
# - Quick startup times
#
# Usage:
# export DOCKER_BUILDKIT=1
# export COMPOSE_DOCKER_CLI_BUILD=1
# docker-compose -f docker/docker-compose.test.yml up --build
#
# Access:
# - Grafana UI: http://localhost:3000 (admin/admin)
# - PostgreSQL: localhost:5432
# - Orchestration: http://localhost:8080
# - Rust Worker: http://localhost:8081
# - Ruby Worker: http://localhost:8082
# - Python Worker: http://localhost:8083
# - OTLP gRPC: localhost:4317
# - Prometheus: http://localhost:9090

services:
  # ==========================================================================
  # Grafana LGTM Stack - All-in-One Observability (TAS-65 Phase 1)
  # ==========================================================================
  # Includes: Loki (logs), Grafana (UI), Tempo (traces), Mimir (metrics)
  # OpenTelemetry integration for distributed tracing and metrics
  observability:
    image: grafana/otel-lgtm:latest
    container_name: tasker-test-observability
    ports:
      # Grafana UI
      - "3000:3000"
      # OTLP receivers
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      # Prometheus metrics
      - "9090:9090"
      # Tempo query
      - "3200:3200"
    environment:
      # Enable all features
      ENABLE_LOGS: "true"
      ENABLE_METRICS: "true"
      ENABLE_TRACES: "true"
    volumes:
      # Persist Grafana dashboards and data sources
      - grafana_data:/var/lib/grafana
      # Persist Tempo traces
      - tempo_data:/var/tempo
      # Persist Loki logs
      - loki_data:/loki
    # TAS-94: Increase memory to prevent OOM under telemetry load
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/ready || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - tasker-test

  # ==========================================================================
  # PostgreSQL Database with PGMQ Extension
  # ==========================================================================
  postgres:
    build:
      context: ..
      dockerfile: docker/db/Dockerfile
    command:
      - "postgres"
      - "-c"
      - "max_connections=500"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
    environment:
      POSTGRES_DB: tasker_rust_test
      POSTGRES_USER: tasker
      POSTGRES_PASSWORD: tasker
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tasker -d tasker_rust_test"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - tasker-test

  # ==========================================================================
  # Orchestration Service - Optimized Test Build
  # ==========================================================================
  orchestration:
    build:
      context: ..
      dockerfile: docker/build/orchestration.test.Dockerfile
      # OPTIMIZATION: BuildKit cache configuration
      # Note: BuildKit must be enabled via environment variables
      cache_from:
        - type=local,src=/tmp/docker-cache/orchestration
      cache_to:
        - type=local,dest=/tmp/docker-cache/orchestration,mode=max
    environment:
      DATABASE_URL: postgresql://tasker:tasker@postgres:5432/tasker_rust_test
      TASKER_ENV: test
      RUST_LOG: info
      LOG_LEVEL: info
      RUST_BACKTRACE: 1
      PORT: 8080
      WORKSPACE_PATH: /app
      # TAS-61 V2: Single-file configuration from v2 directory
      TASKER_CONFIG_PATH: /app/config/tasker/orchestration-test.toml
      # Migration settings
      RUN_MIGRATIONS: "true"
      DEPLOYMENT_MODE: standard
      SKIP_MIGRATION_PROMPT: "true"
      DB_MIGRATION_RETRIES: "3"
      DB_MIGRATION_RETRY_DELAY: "5"
      DB_MIGRATION_TIMEOUT: "120"
      # TAS-65 Phase 1: OpenTelemetry configuration
      # TAS-94: Traces only mode - logs go to stdout, traces to OTEL
      # This reduces telemetry volume and prevents collector OOM
      TELEMETRY_ENABLED: "true"
      OTEL_LOGS_ENABLED: "false"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://observability:4317
      OTEL_SERVICE_NAME: tasker-orchestration
      OTEL_SERVICE_VERSION: "0.1.0"
    ports:
      - "8080:8080"
    volumes:
      - ../config/tasker:/app/config/tasker:ro
    depends_on:
      postgres:
        condition: service_healthy
      observability:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - tasker-test

  # ==========================================================================
  # Rust Worker Service - Optimized Test Build
  # ==========================================================================
  rust-worker:
    build:
      context: ..
      dockerfile: docker/build/rust-worker.test.Dockerfile
      # OPTIMIZATION: BuildKit cache configuration
      cache_from:
        - type=local,src=/tmp/docker-cache/rust-worker
      cache_to:
        - type=local,dest=/tmp/docker-cache/rust-worker,mode=max
    environment:
      DATABASE_URL: postgresql://tasker:tasker@postgres:5432/tasker_rust_test
      TASKER_ENV: test
      RUST_LOG: info
      LOG_LEVEL: info
      RUST_BACKTRACE: 1
      WORKER_ID: test-worker-001
      WORKSPACE_PATH: /app
      # TAS-61 V2: Single-file configuration from v2 directory
      TASKER_CONFIG_PATH: /app/config/tasker/worker-test.toml
      # Point to centralized E2E test templates for Rust handlers
      TASKER_TEMPLATE_PATH: /app/tests/fixtures/task_templates/rust
      # Point to fixture files for E2E tests
      TASKER_FIXTURE_PATH: /app/tests/fixtures
      PORT: 8081
      # TAS-65 Phase 1: OpenTelemetry configuration
      # TAS-94: Traces only mode - logs go to stdout, traces to OTEL
      TELEMETRY_ENABLED: "true"
      OTEL_LOGS_ENABLED: "false"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://observability:4317
      OTEL_SERVICE_NAME: tasker-rust-worker
      OTEL_SERVICE_VERSION: "0.1.0"
    ports:
      - "8081:8081"
    volumes:
      - ../config/tasker:/app/config/tasker:ro
      # Mount centralized test templates
      - ../tests/fixtures/task_templates/rust:/app/tests/fixtures/task_templates/rust:ro
      # Mount test fixtures for CSV and other data files
      - ../tests/fixtures:/app/tests/fixtures:ro
    depends_on:
      postgres:
        condition: service_healthy
      observability:
        condition: service_healthy
      orchestration:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - tasker-test

  # ==========================================================================
  # Ruby Worker Service - Optimized Test Build with Ruby FFI Support
  # ==========================================================================
  ruby-worker:
    build:
      context: ..
      dockerfile: docker/build/ruby-worker.test.Dockerfile
      # OPTIMIZATION: BuildKit cache configuration
      cache_from:
        - type=local,src=/tmp/docker-cache/ruby-worker
      cache_to:
        - type=local,dest=/tmp/docker-cache/ruby-worker,mode=max
    environment:
      DATABASE_URL: postgresql://tasker:tasker@postgres:5432/tasker_rust_test
      TASKER_ENV: test
      RUST_LOG: info
      LOG_LEVEL: info
      RUST_BACKTRACE: 1
      WORKER_ID: test-ruby-worker-001
      WORKSPACE_PATH: /app
      # TAS-61 V2: Single-file configuration from v2 directory
      TASKER_CONFIG_PATH: /app/config/tasker/worker-test.toml
      # Point to centralized E2E test templates for Ruby handlers
      TASKER_TEMPLATE_PATH: /app/tests/fixtures/task_templates/ruby
      # Point to fixture files for E2E tests
      TASKER_FIXTURE_PATH: /app/tests/fixtures
      # Ruby environment
      RUBY_WORKER_ENABLED: "true"
      BUNDLE_GEMFILE: /app/ruby_worker/Gemfile
      # Service configuration - internal port matches Rust worker
      # External port 8082 is mapped via Docker, internal binding is 8081
      PORT: 8081
      # TAS-65 Phase 1: OpenTelemetry configuration
      # TAS-94: Traces only mode - logs go to stdout, traces to OTEL
      TELEMETRY_ENABLED: "true"
      OTEL_LOGS_ENABLED: "false"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://observability:4317
      OTEL_SERVICE_NAME: tasker-ruby-worker
      OTEL_SERVICE_VERSION: "0.1.0"
    ports:
      - "8082:8081" # Map to 8082 externally, 8081 internally (same as Rust worker)
    volumes:
      - ../config/tasker:/app/config/tasker:ro
      # Mount centralized test templates
      - ../tests/fixtures/task_templates/ruby:/app/tests/fixtures/task_templates/ruby:ro
      # Mount test fixtures for CSV and other data files
      - ../tests/fixtures:/app/tests/fixtures:ro
      # Mount handler source code for discovery (must match Dockerfile structure)
      - ../workers/ruby/spec/handlers:/app/ruby_worker/spec/handlers:ro
    depends_on:
      postgres:
        condition: service_healthy
      observability:
        condition: service_healthy
      orchestration:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 5 # More retries for CI environment
      start_period: 60s # Ruby FFI bootstrap + Rust worker + web API binding can take time in CI
    networks:
      - tasker-test

  # ==========================================================================
  # Python Worker Service - Optimized Test Build with PyO3 FFI Support
  # ==========================================================================
  python-worker:
    build:
      context: ..
      dockerfile: docker/build/python-worker.test.Dockerfile
      # OPTIMIZATION: BuildKit cache configuration
      cache_from:
        - type=local,src=/tmp/docker-cache/python-worker
      cache_to:
        - type=local,dest=/tmp/docker-cache/python-worker,mode=max
    environment:
      DATABASE_URL: postgresql://tasker:tasker@postgres:5432/tasker_rust_test
      TASKER_ENV: test
      RUST_LOG: info
      LOG_LEVEL: info
      RUST_BACKTRACE: 1
      WORKER_ID: test-python-worker-001
      WORKSPACE_PATH: /app
      # TAS-61 V2: Single-file configuration from v2 directory
      TASKER_CONFIG_PATH: /app/config/tasker/worker-test.toml
      # Point to centralized E2E test templates for Python handlers
      TASKER_TEMPLATE_PATH: /app/tests/fixtures/task_templates/python
      # Point to fixture files for E2E tests
      TASKER_FIXTURE_PATH: /app/tests/fixtures
      # Python environment
      PYTHON_WORKER_ENABLED: "true"
      PYTHONPATH: /app/python_worker/python
      # Override handler path to use volume mount (allows live code updates)
      PYTHON_HANDLER_PATH: /app/python_worker/tests/handlers
      # Service configuration - internal port matches Rust worker
      # External port 8083 is mapped via Docker, internal binding is 8081
      PORT: 8081
      # TAS-65 Phase 1: OpenTelemetry configuration
      # TAS-94: Traces only mode - logs go to stdout, traces to OTEL
      TELEMETRY_ENABLED: "true"
      OTEL_LOGS_ENABLED: "false"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://observability:4317
      OTEL_SERVICE_NAME: tasker-python-worker
      OTEL_SERVICE_VERSION: "0.1.0"
    ports:
      - "8083:8081" # Map to 8083 externally, 8081 internally (same as Rust worker)
    volumes:
      - ../config/tasker:/app/config/tasker:ro
      # Mount centralized test templates
      - ../tests/fixtures/task_templates/python:/app/tests/fixtures/task_templates/python:ro
      # Mount test fixtures for CSV and other data files
      - ../tests/fixtures:/app/tests/fixtures:ro
      # Mount handler source code for discovery (must match Dockerfile structure)
      - ../workers/python/tests/handlers:/app/python_worker/tests/handlers:ro
    depends_on:
      postgres:
        condition: service_healthy
      observability:
        condition: service_healthy
      orchestration:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 5 # More retries for CI environment
      start_period: 60s # Python FFI bootstrap + Rust worker + web API binding can take time in CI
    networks:
      - tasker-test

  # ==========================================================================
  # TypeScript Worker Service - Optimized Test Build with Bun FFI Support
  # ==========================================================================
  typescript-worker:
    build:
      context: ..
      dockerfile: docker/build/typescript-worker.test.Dockerfile
      # OPTIMIZATION: BuildKit cache configuration
      cache_from:
        - type=local,src=/tmp/docker-cache/typescript-worker
      cache_to:
        - type=local,dest=/tmp/docker-cache/typescript-worker,mode=max
    environment:
      DATABASE_URL: postgresql://tasker:tasker@postgres:5432/tasker_rust_test
      TASKER_ENV: test
      RUST_LOG: info
      LOG_LEVEL: info
      RUST_BACKTRACE: 1
      WORKER_ID: test-typescript-worker-001
      WORKSPACE_PATH: /app
      # TAS-61 V2: Single-file configuration from v2 directory
      TASKER_CONFIG_PATH: /app/config/tasker/worker-test.toml
      # Point to centralized E2E test templates for TypeScript handlers
      TASKER_TEMPLATE_PATH: /app/tests/fixtures/task_templates/typescript
      # Point to fixture files for E2E tests
      TASKER_FIXTURE_PATH: /app/tests/fixtures
      # TypeScript environment
      TYPESCRIPT_WORKER_ENABLED: "true"
      # Override handler path to use volume mount (allows live code updates)
      TYPESCRIPT_HANDLER_PATH: /app/typescript_worker/tests/handlers
      # FFI library path
      TASKER_FFI_LIBRARY_PATH: /app/lib/libtasker_worker.so
      # Service configuration - internal port matches Rust worker
      # External port 8085 is mapped via Docker, internal binding is 8081
      # Note: Port 8084 conflicts with Mono XSP4 on GitHub Actions runners
      PORT: 8081
      # TAS-65 Phase 1: OpenTelemetry configuration
      # TAS-94: Traces only mode - logs go to stdout, traces to OTEL
      TELEMETRY_ENABLED: "true"
      OTEL_LOGS_ENABLED: "false"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://observability:4317
      OTEL_SERVICE_NAME: tasker-typescript-worker
      OTEL_SERVICE_VERSION: "0.1.0"
    ports:
      - "8085:8081" # Map to 8085 externally, 8081 internally (same as Rust worker)
    volumes:
      - ../config/tasker:/app/config/tasker:ro
      # Mount centralized test templates
      - ../tests/fixtures/task_templates/typescript:/app/tests/fixtures/task_templates/typescript:ro
      # Mount test fixtures for CSV and other data files
      - ../tests/fixtures:/app/tests/fixtures:ro
      # Mount handler source code for discovery (must match Dockerfile structure)
      - ../workers/typescript/tests/handlers:/app/typescript_worker/tests/handlers:ro
    depends_on:
      postgres:
        condition: service_healthy
      observability:
        condition: service_healthy
      orchestration:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 5 # More retries for CI environment
      start_period: 60s # TypeScript FFI bootstrap + Rust worker + web API binding can take time in CI
    networks:
      - tasker-test

volumes:
  postgres_data:
  grafana_data:
  tempo_data:
  loki_data:

networks:
  tasker-test:
    driver: bridge
